<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.120.1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Morven's Life"><meta property="og:url" content="https://morven.life/posts/create-pki-with-openssl/"><link rel=canonical href=https://morven.life/posts/create-pki-with-openssl/><link rel=apple-touch-icon href=https://morven.life/favicon.ico><link rel=icon href=https://morven.life/favicon.ico><link rel=shortcut href=https://morven.life/favicon.ico><link rel=alternate type=application/atom+xml href=https://morven.life/index.xml title="Morven's Life"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/morven.life\/"},"articleSection":"posts","name":"创建私有 CA 以及颁发数字证书","headline":"创建私有 CA 以及颁发数字证书","description":"在上一篇文章深入理解PKI系统的与数字证书中介绍了 PKI 系统的基本组成以及 CA 认证中心的主要作用，以及 X.509 证书基本标准。今天，我们继续应用已经学习的理论知识构建一套自己的 PKI\/CA 数字证书信任体系。\n数字证书生成工具 有以下两种常见的工具来生成 RSA 公私密钥对:\nNote: 有些情形只需要公私密钥对就够了，不需要数字证书，比如私有的 SSH 服务，但是对于一些要求身份认证的情形，则需要对公钥进行数字签名形成数字证书。\nssh-keygen openssl genrsa 实际上 ssh-keygen 底层也是使用 openssl 提供的库来生成密钥对。\nssh-keygen 举例来说，要使用 ssh-keygen 生成2048位 RSA 密钥对，只需要执行以下命令：\n$ ssh-keygen -b 2048 -t rsa -f foo_rsa Generating public\/private rsa key pair. Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in foo_rsa. Your public key has been saved in foo_rsa.pub. The key fingerprint is: b8:c4:5f:2a:94:fd:b9:56:9d:5b:fd:96:02:5a:7e:b7 user@oasis The key\u0026#39;s randomart image is: \u002b--[ RSA 2048]----\u002b | | | | | | | .","inLanguage":"en-US","author":"Morven\u0027s Life","creator":"Morven\u0027s Life","publisher":"Morven\u0027s Life","accountablePerson":"Morven\u0027s Life","copyrightHolder":"Morven\u0027s Life","copyrightYear":"2014","datePublished":"2014-11-24 00:00:00 \u002b0000 UTC","dateModified":"2014-11-24 00:00:00 \u002b0000 UTC","url":"https:\/\/morven.life\/posts\/create-pki-with-openssl\/","keywords":[]}</script><title>创建私有 CA 以及颁发数字证书</title>
<meta property="og:title" content="创建私有 CA 以及颁发数字证书"><meta property="og:type" content="article"><meta property="og:description" content="在上一篇文章深入理解PKI系统的与数字证书中介绍了 PKI 系统的基本组成以及 CA 认证中心的主要作用，以及 X.509 证书基本标准。今天，我们继续应用已经学习的理论知识构建一套自己的 PKI/CA 数字证书信任体系。
数字证书生成工具 有以下两种常见的工具来生成 RSA 公私密钥对:
Note: 有些情形只需要公私密钥对就够了，不需要数字证书，比如私有的 SSH 服务，但是对于一些要求身份认证的情形，则需要对公钥进行数字签名形成数字证书。
ssh-keygen openssl genrsa 实际上 ssh-keygen 底层也是使用 openssl 提供的库来生成密钥对。
ssh-keygen 举例来说，要使用 ssh-keygen 生成2048位 RSA 密钥对，只需要执行以下命令：
$ ssh-keygen -b 2048 -t rsa -f foo_rsa Generating public/private rsa key pair. Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in foo_rsa. Your public key has been saved in foo_rsa.pub. The key fingerprint is: b8:c4:5f:2a:94:fd:b9:56:9d:5b:fd:96:02:5a:7e:b7 user@oasis The key&amp;#39;s randomart image is: +--[ RSA 2048]----+ | | | | | | | ."><meta name=description content="在上一篇文章深入理解PKI系统的与数字证书中介绍了 PKI 系统的基本组成以及 CA 认证中心的主要作用，以及 X.509 证书基本标准。今天，我们继续应用已经学习的理论知识构建一套自己的 PKI/CA 数字证书信任体系。
数字证书生成工具 有以下两种常见的工具来生成 RSA 公私密钥对:
Note: 有些情形只需要公私密钥对就够了，不需要数字证书，比如私有的 SSH 服务，但是对于一些要求身份认证的情形，则需要对公钥进行数字签名形成数字证书。
ssh-keygen openssl genrsa 实际上 ssh-keygen 底层也是使用 openssl 提供的库来生成密钥对。
ssh-keygen 举例来说，要使用 ssh-keygen 生成2048位 RSA 密钥对，只需要执行以下命令：
$ ssh-keygen -b 2048 -t rsa -f foo_rsa Generating public/private rsa key pair. Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in foo_rsa. Your public key has been saved in foo_rsa.pub. The key fingerprint is: b8:c4:5f:2a:94:fd:b9:56:9d:5b:fd:96:02:5a:7e:b7 user@oasis The key&amp;#39;s randomart image is: +--[ RSA 2048]----+ | | | | | | | ."><meta property="og:locale" content="cn"><style>body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:#000;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:#000}.markdown-body blockquote{background-color:#f8f8f8;border-left:2px solid;margin:40px;padding:10px 20px}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:#f6f8fa;border-radius:6px}.markdown-body pre>code{padding:0;font-size:85%;background-color:inherit;border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.signatures{font-family:permanent marker,Impact,Charcoal,sans-serif;font-size:3rem;margin-top:32px}.signatures a{text-decoration:none}.header-line{width:100%;height:3px;background-color:#000;margin:18px 0}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-date,.posts-title{font-size:1.2rem}.posts-line{margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px;margin-bottom:3px}.site-footer{margin-top:50px;margin-bottom:80px;display:flex;justify-content:flex-end;flex-wrap:wrap;padding:12px 0;border-width:3px;border-color:#000}.site-footer-item{margin-right:12px}@media screen and (max-width:600px){.site-header{display:none}.post-content{padding:0 12px}.post-content p{letter-spacing:.05em}}@media screen and (max-width:48em){.posts-category{display:none}}.post-content img{max-width:100%;display:block;margin-left:auto;margin-right:auto;margin-top:12px}.post-header{margin-bottom:50px}.post-title{font-size:2.5rem;font-weight:600}.post-category{display:inline;font-weight:900;margin:0 4px;padding:2px 5px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link href=https://morven.life/index.xml rel=alternate type=application/rss+xml title="Morven's Life"><link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel=stylesheet></head><body><article class="post 简体中文" id=article><div class=row><div class=col-xs-12><header class=post-header><h1 class=post-title>创建私有 CA 以及颁发数字证书</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2014-11-24 00:00:00 UTC">24 Nov 2014</time></div><div class=col-xs-6><div class=post-author><a target=_blank href=https://morven.life/>@Morven's Life</a></div></div></div></header><div class="post-content markdown-body"><p>在上一篇文章<a href=https://morven.life/posts/pki-and-digital-certificate/>深入理解PKI系统的与数字证书</a>中介绍了 PKI 系统的基本组成以及 CA 认证中心的主要作用，以及 X.509 证书基本标准。今天，我们继续应用已经学习的理论知识构建一套自己的 PKI/CA 数字证书信任体系。</p><h2 id=数字证书生成工具>数字证书生成工具</h2><p>有以下两种常见的工具来生成 <code>RSA</code> 公私密钥对:</p><blockquote><p>Note: 有些情形只需要公私密钥对就够了，不需要数字证书，比如私有的 <code>SSH</code> 服务，但是对于一些要求身份认证的情形，则需要对公钥进行数字签名形成数字证书。</p></blockquote><ul><li><code>ssh-keygen</code></li><li><code>openssl genrsa</code></li></ul><p>实际上 <code>ssh-keygen</code> 底层也是使用 <code>openssl</code> 提供的库来生成密钥对。</p><h3 id=ssh-keygen>ssh-keygen</h3><p>举例来说，要使用 <code>ssh-keygen</code> 生成2048位 RSA 密钥对，只需要执行以下命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ ssh-keygen -b <span style=color:#0000cf;font-weight:700>2048</span> -t rsa -f foo_rsa
</span></span><span style=display:flex><span>Generating public/private rsa key pair.
</span></span><span style=display:flex><span>Enter passphrase <span style=color:#ce5c00;font-weight:700>(</span>empty <span style=color:#204a87;font-weight:700>for</span> no passphrase<span style=color:#ce5c00;font-weight:700>)</span>: 
</span></span><span style=display:flex><span>Enter same passphrase again: 
</span></span><span style=display:flex><span>Your identification has been saved in foo_rsa.
</span></span><span style=display:flex><span>Your public key has been saved in foo_rsa.pub.
</span></span><span style=display:flex><span>The key fingerprint is:
</span></span><span style=display:flex><span>b8:c4:5f:2a:94:fd:b9:56:9d:5b:fd:96:02:5a:7e:b7 user@oasis
</span></span><span style=display:flex><span>The key<span style=color:#a40000>&#39;</span>s randomart image is:
</span></span><span style=display:flex><span>+--<span style=color:#ce5c00;font-weight:700>[</span> RSA 2048<span style=color:#ce5c00;font-weight:700>]</span>----+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>                 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>                 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>                 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     . +         <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>      * S .  . ..<span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     o o + +. o o<span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>      o o *..  oo<span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       . ..o o.oo<span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>         .. . oE.<span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------------+
</span></span></code></pre></div><p>其中 <code>-b</code> 指定密钥位数，一般指定2048以上， <code>-t</code> 指定密钥类型，如 <code>rsa/dsa/ecdsa</code></p><blockquote><p>Note: 如果密钥对用于 <code>ssh</code> ，那么习惯上私钥命名为 <code>id_rsa</code> ，对应的公钥就是 <code>id_rsa.pub</code> ，然后可以使用 <code>ssh-copy-id</code> 命令把密钥追加到远程主机的 <code>.ssh/authorized_key</code> 的受信列表里。</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ ssh-copy-id -i ~/.ssh/id_rsa.pub user@mc-lnx
</span></span></code></pre></div><p>默认生成的密钥对是使用 <code>RFC 4716/SSH2</code> 格式，可以转到 <code>PEM</code> 格式供其他程序使用：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ ssh-keygen -f id_rsa.pub -e -m pem
</span></span><span style=display:flex><span>-----BEGIN RSA PUBLIC KEY-----
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>-----END RSA PUBLIC KEY-----
</span></span></code></pre></div><p>其中 <code>-m</code> 指定转换后的格式，支持 <code>RFC4716/PKCS8/PEM</code> 。</p><h3 id=openssl>openssl</h3><p><code>openssl</code> 是一个强大的安全套接字层密码库工具包，整个软件包大概可以分成三个主要的功能部分：</p><ol><li>密码算法库</li><li>常用的密钥和证书封装管理功能</li><li>SSL 通信 API 接口</li><li>丰富的应用程序供测试或其它目的使用</li></ol><p>使用 <code>openssl</code> 开发套件可以完成以下功能：</p><ol><li>建立 <code>RSA</code>、<code>DH</code>、<code>DSA</code> key 参数</li><li>生成 X.509 证书、证书签名请求(CSR)和CRL(证书回收列表)</li><li>计算消息摘要(Digest)</li><li>使用各种 <code>Cipher</code> 加密/解密</li><li><code>SSL/TLS</code> 客户端以及服务器的测试</li><li>处理 <code>S/MIME</code> 或者加密邮件</li></ol><p><code>openssl</code>提供了很多不同的命令，每个子命令有很多的选项和参数，这里就不详细列举。</p><h2 id=数字证书生成过程>数字证书生成过程</h2><p>使用<code>openssl</code>这个套件可以完成 CA 的搭建、 SSL 证书从生成到签发的全部过程，在使用 <code>openssl</code> 指令的时候，需要记住以下几点：</p><ol><li>在生成过程中有很多文件扩展名(<code>.crt</code>、<code>.csr</code>、<code>.pem</code>、<code>.key</code>等)，虽然说扩展名并不具有任何强制约束作用，重要的是这个文件是由哪个命令生成的，它的内容是什么格式的，使用这些特定的文件扩展名只是为了遵循某些约定俗称的规范，让人能一目了然；</li><li><code>openssl</code> 的指令之间具有一些功能上的重叠，所以我们会发现完成同样一个目的(例如 SSL 证书生成)，往往可以使用看似不同的指令组达到目的；</li><li>理解 CA 、 SSL 证书最重要的不是记住这些 <code>openssl</code> 指令，而是要理解 CA 的运行机制，同时理解 <code>openssl</code> 指令的功能，从原理上去理解整个流程；</li></ol><h3 id=创建-ca-根证书>创建 CA 根证书</h3><p>CA 根证书是 PKI 体系中重要的组成部分，要建立树状的受信任体系，首先 CA 自身需要表明身份，并建立树根，其他的中级证书都依赖该根来签发证书，并通过根证书建立彼此的信任关系。 CA 证书由私钥(Root Key)和公钥(Root Cert)组成。 CA 根证书并不直接颁发服务器证书和客户端证书，仅用来颁发一个或多个中级证书，中级证书代理 CA 根证书向用户和服务器颁发证书。同时，为了保证 CA 根证书的可靠性，应保证 CA 根证书对应的私钥 (Root Key)处于离线并安全保存。</p><ol><li>创建 CA 根证书的私钥保存目录：</li></ol><p>选择一个目录用于存储所有的私钥和公钥：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir /root/ca
</span></span></code></pre></div><p>创建目录结构，生成 <code>index.txt</code> 和<code> serial</code> 文件，用于作为文件数据库追踪以前发的证书：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#204a87>cd</span> /root/ca
</span></span><span style=display:flex><span>$ mkdir certs crl newcerts private
</span></span><span style=display:flex><span>$ chmod <span style=color:#0000cf;font-weight:700>700</span> private
</span></span><span style=display:flex><span>$ touch index.txt
</span></span><span style=display:flex><span>$ <span style=color:#204a87>echo</span> <span style=color:#0000cf;font-weight:700>1000</span> &gt; serial
</span></span></code></pre></div><ul><li>certs 存放已签发的证书</li><li>newcerts 存放 CA 生成的新证书</li><li>private 存放私钥</li><li>crl 存放以吊销的证书</li><li>index.txt 定义使用 <code>openssl</code> 已签发证书的文本数据库文件，通常该文件在初始化时为空</li><li>serial 签发证书时使用的序列号参考文件，该文件中的序列号为16进制数，初始化时必须提供并包含一个有效的序列号</li></ul><ol start=2><li>创建 CA 根证书的配置文件：</li></ol><p>为 <code>openssl</code> 创建 CA 根证书的配置文件，保存在 <code>/root/ca/openssl.cnf</code> ，文件中 <code>[ ca ]</code> 部分是必须存在的，用于告诉 openssl 根证书使用的配置信息：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[ ca ]
</span></span><span style=display:flex><span># `man ca`
</span></span><span style=display:flex><span>default_ca= CA_default
</span></span></code></pre></div><p>在 <code>[ CA_default ]</code> 部分配置根证书的基础信息：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[ CA_default ]
</span></span><span style=display:flex><span># Directory and file locations.
</span></span><span style=display:flex><span>dir               = /root/ca
</span></span><span style=display:flex><span>certs             = $dir/certs
</span></span><span style=display:flex><span>crl_dir           = $dir/crl
</span></span><span style=display:flex><span>new_certs_dir     = $dir/newcerts
</span></span><span style=display:flex><span>database          = $dir/index.txt
</span></span><span style=display:flex><span>serial            = $dir/serial
</span></span><span style=display:flex><span>RANDFILE          = $dir/private/.rand
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span># The root key and root certificate.
</span></span><span style=display:flex><span>private_key       = $dir/private/ca.key.pem
</span></span><span style=display:flex><span>certificate       = $dir/certs/ca.cert.pem
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span># For certificate revocation lists.
</span></span><span style=display:flex><span>crlnumber         = $dir/crlnumber
</span></span><span style=display:flex><span>crl               = $dir/crl/ca.crl.pem
</span></span><span style=display:flex><span>crl_extensions    = crl_ext
</span></span><span style=display:flex><span>default_crl_days  = 30
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span># SHA-1 is deprecated, so use SHA-2 instead.
</span></span><span style=display:flex><span>default_md        = sha256
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>name_opt          = ca_default
</span></span><span style=display:flex><span>cert_opt          = ca_default
</span></span><span style=display:flex><span>default_days      = 375
</span></span><span style=display:flex><span>preserve          = no
</span></span><span style=display:flex><span>policy            = policy_strict
</span></span></code></pre></div><p>创建根证书签名策略，作为根证书仅用来签发中级 CA 证书：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[ policy_strict ]
</span></span><span style=display:flex><span># The root CA should only sign intermediate certificates that match.
</span></span><span style=display:flex><span># See the POLICY FORMAT section of `man ca`.
</span></span><span style=display:flex><span>countryName             = match
</span></span><span style=display:flex><span>stateOrProvinceName     = match
</span></span><span style=display:flex><span>organizationName        = match
</span></span><span style=display:flex><span>organizationalUnitName  = optional
</span></span><span style=display:flex><span>commonName              = supplied
</span></span><span style=display:flex><span>emailAddress            = optional
</span></span></code></pre></div><p>为中级 CA 证书创建相对宽松的证书签名策略，中级 CA 证书可以为第三方终端用户和服务器签发证书：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy_loose</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Allow the intermediate CA to sign a more diverse range of certificates.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># See the POLICY FORMAT section of the `ca` man page.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>countryName</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>stateOrProvinceName</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>localityName</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>organizationName</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>organizationalUnitName</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>commonName</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>supplied</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>emailAddress</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><code>[ req ]</code> 部分主要定义了创建证书和证书请求时默认选项：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>req</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Options for the `req` tool (`man req`).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>default_bits</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2048</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>distinguished_name</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>req_distinguished_name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>string_mask</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>utf8only</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># SHA-1 is deprecated, so use SHA-2 instead.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>default_md</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sha256</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Extension to add when the -x509 option is used.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>x509_extensions</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v3_ca</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><code>[ req_distinguished_name ]</code> 部分定义了生成证书请求时常用的信息说明和默认值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[ req_distinguished_name ]
</span></span><span style=display:flex><span># See &lt;https://en.wikipedia.org/wiki/Certificate_signing_request&gt;.
</span></span><span style=display:flex><span>countryName                     = Country Name (2 letter code)
</span></span><span style=display:flex><span>stateOrProvinceName             = State or Province Name
</span></span><span style=display:flex><span>localityName                    = Locality Name
</span></span><span style=display:flex><span>0.organizationName              = Organization Name
</span></span><span style=display:flex><span>organizationalUnitName          = Organizational Unit Name
</span></span><span style=display:flex><span>commonName                      = Common Name
</span></span><span style=display:flex><span>emailAddress                    = Email Address
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span># Optionally, specify some defaults.
</span></span><span style=display:flex><span>countryName_default             = GB
</span></span><span style=display:flex><span>stateOrProvinceName_default     = England
</span></span><span style=display:flex><span>localityName_default            =
</span></span><span style=display:flex><span>0.organizationName_default      = Alice Ltd
</span></span><span style=display:flex><span>#organizationalUnitName_default =
</span></span><span style=display:flex><span>#emailAddress_default           =
</span></span></code></pre></div><p>在 <code>openssl</code> 中，除了配置基本的必要信息外，还有一些可扩展的选项可用于证书签发：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[ v3_ca ]
</span></span><span style=display:flex><span># Extensions for a typical CA (`man x509v3_config`).
</span></span><span style=display:flex><span>subjectKeyIdentifier = hash
</span></span><span style=display:flex><span>authorityKeyIdentifier = keyid:always,issuer
</span></span><span style=display:flex><span>basicConstraints = critical, CA:true
</span></span><span style=display:flex><span>keyUsage = critical, digitalSignature, cRLSign, keyCertSign
</span></span></code></pre></div><p>定义中级 CA 证书签发的扩展选项，其中 <code>pathlen:0</code> 是为了确保中级 CA 证书不能再签发新的中级 CA 证书：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[ v3_intermediate_ca ]
</span></span><span style=display:flex><span># Extensions for a typical intermediate CA (`man x509v3_config`).
</span></span><span style=display:flex><span>subjectKeyIdentifier = hash
</span></span><span style=display:flex><span>authorityKeyIdentifier = keyid:always,issuer
</span></span><span style=display:flex><span>basicConstraints = critical, CA:true, pathlen:0
</span></span><span style=display:flex><span>keyUsage = critical, digitalSignature, cRLSign, keyCertSign
</span></span></code></pre></div><p>在 <code>[ user_cert]</code> 部分约束签发客户端证书策略，该证书一般用于用户身份认证：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[ usr_cert ]
</span></span><span style=display:flex><span># Extensions for client certificates (`man x509v3_config`).
</span></span><span style=display:flex><span>basicConstraints = CA:FALSE
</span></span><span style=display:flex><span>nsCertType = client, email
</span></span><span style=display:flex><span>nsComment = &#34;OpenSSL Generated Client Certificate&#34;
</span></span><span style=display:flex><span>subjectKeyIdentifier = hash
</span></span><span style=display:flex><span>authorityKeyIdentifier = keyid,issuer
</span></span><span style=display:flex><span>keyUsage = critical, nonRepudiation, digitalSignature, keyEncipherment
</span></span><span style=display:flex><span>extendedKeyUsage = clientAuth, emailProtection
</span></span></code></pre></div><p>在 <code>[ server_cert ]</code> 部分，定义了签发服务器证书时的证书签发策略：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[ server_cert ]
</span></span><span style=display:flex><span># Extensions for server certificates (`man x509v3_config`).
</span></span><span style=display:flex><span>basicConstraints = CA:FALSE
</span></span><span style=display:flex><span>nsCertType = server
</span></span><span style=display:flex><span>nsComment = &#34;OpenSSL Generated Server Certificate&#34;
</span></span><span style=display:flex><span>subjectKeyIdentifier = hash
</span></span><span style=display:flex><span>authorityKeyIdentifier = keyid,issuer:always
</span></span><span style=display:flex><span>keyUsage = critical, digitalSignature, keyEncipherment
</span></span><span style=display:flex><span>extendedKeyUsage = serverAuth
</span></span></code></pre></div><p><code>[ crt_ext ]</code> 部分用于定义创建证书吊销列表 CRL 时的策略：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[ crl_ext ]
</span></span><span style=display:flex><span># Extension for CRLs (`man x509v3_config`).
</span></span><span style=display:flex><span>authorityKeyIdentifier=keyid:always
</span></span></code></pre></div><p>定义在线证书使用策略 <code>ocsp</code> ：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[ ocsp ]
</span></span><span style=display:flex><span># Extension for OCSP signing certificates (`man ocsp`).
</span></span><span style=display:flex><span>basicConstraints = CA:FALSE
</span></span><span style=display:flex><span>subjectKeyIdentifier = hash
</span></span><span style=display:flex><span>authorityKeyIdentifier = keyid,issuer
</span></span><span style=display:flex><span>keyUsage = critical, digitalSignature
</span></span><span style=display:flex><span>extendedKeyUsage = critical, OCSPSigning
</span></span></code></pre></div><ol start=3><li>创建根证书私钥：</li></ol><p>生成的根证书私钥必须保证其绝对的安全，并使用 <code>aes-256</code> 加密和高强度密码保护：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#204a87>cd</span> /root/ca
</span></span><span style=display:flex><span>$ openssl genrsa  -aes256 -out private/ca.key.pem <span style=color:#0000cf;font-weight:700>4096</span>
</span></span><span style=display:flex><span>Enter pass phrase <span style=color:#204a87;font-weight:700>for</span> ca.key.pem: secretpassword 
</span></span><span style=display:flex><span>Verifying - Enter pass phrase <span style=color:#204a87;font-weight:700>for</span> ca.key.pem: secretpassword
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ chmod <span style=color:#0000cf;font-weight:700>400</span> private/ca.key.pem
</span></span></code></pre></div><ul><li><code>genrsa</code> 使用 RSA 算法产生私钥</li><li><code>-aes256</code> 使用256位密钥的 AES 算法对私钥进行加密</li><li><code>-out</code> 输出文件目录</li><li><code>4096</code> 指定密钥的长度</li></ul><ol start=4><li>创建根证书</li></ol><p>使用根证书私钥(<code>ca.key.pem</code>)创建根证书(<code>ca.cert.pem</code>)。需要为根证书指定较长的有效期，一旦根证书过期，其所有签发的证书将都不可用。在使用 <code>req</code> 命令时，必须使用 <code>-config</code> 指定配置文件，否则程序默认使用 <code>/etc/pki/tls/openssl.cnf</code> 配置文件。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#204a87>cd</span> /root/ca
</span></span><span style=display:flex><span>openssl req -config openssl.cnf -key private/ca.key.pem -new -x509 -days <span style=color:#0000cf;font-weight:700>7300</span> -sha256 -extensions v3_ca -out certs/ca.cert.pem
</span></span><span style=display:flex><span>Enter pass phrase <span style=color:#204a87;font-weight:700>for</span> ca.key.pem: secretpassword
</span></span><span style=display:flex><span>You are about to be asked to enter information that will be incorporated
</span></span><span style=display:flex><span>into your certificate request.
</span></span><span style=display:flex><span>-----
</span></span><span style=display:flex><span>Country Name <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span> letter code<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>[</span>XX<span style=color:#ce5c00;font-weight:700>]</span>:GB
</span></span><span style=display:flex><span>State or Province Name <span style=color:#ce5c00;font-weight:700>[]</span>:England
</span></span><span style=display:flex><span>Locality Name <span style=color:#ce5c00;font-weight:700>[]</span>:
</span></span><span style=display:flex><span>Organization Name <span style=color:#ce5c00;font-weight:700>[]</span>:Alice Ltd
</span></span><span style=display:flex><span>Organizational Unit Name <span style=color:#ce5c00;font-weight:700>[]</span>:Alice Ltd Certificate Authority
</span></span><span style=display:flex><span>Common Name <span style=color:#ce5c00;font-weight:700>[]</span>:Alice Ltd Root CA
</span></span><span style=display:flex><span>Email Address <span style=color:#ce5c00;font-weight:700>[]</span>:
</span></span><span style=display:flex><span>$ chmod <span style=color:#0000cf;font-weight:700>444</span> certs/ca.cert.pem
</span></span></code></pre></div><ol start=5><li>验证签发的根证书</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ openssl x509 -noout -text -in certs/ca.cert.pem
</span></span></code></pre></div><p>需要确认一下信息：</p><ul><li>确认 Signature Algorithm 使用的签名算法</li><li>确认 Validity 中的证书有效期</li><li>确认 Public-Key 长度</li><li>确认 Issuer 描述的签发者信息</li><li>确认 Subject 指定的证书持有者信息，但要注意根证书为自签名证书，所以 Subject 与 Issuer 信息相同</li></ul><ol start=6><li>创建中级 CA 证书密钥对</li></ol><p>中级 CA 证书用于代替根证书签发客户端证书和服务器证书，根证书负责签发中级 CA 证书并维护受信任的证书链。使用中级证书主要是处于安全考虑，因为根证书对应的根证书私钥始终处理物理隔离并能够保障私钥的绝对安全，在中级 CA 证书的私钥发生泄漏后，可以通过根证书吊销该证书，并重新签发新的中级证书密钥对。</p><ol start=7><li>创建中级 CA 证书目录结构</li></ol><p>与根证书类是，我们需要为中级 CA 证书创建用于存储证书的目录。这里我们将中级证书所有内容保存在 <code>/root/ca/intermediate</code> 目录下面，并创建类似于根证书的目录结构：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir /root/ca/intermediate
</span></span><span style=display:flex><span>$ <span style=color:#204a87>cd</span> /root/ca/intermediate
</span></span><span style=display:flex><span>$ mkdir certs crl newcerts private
</span></span><span style=display:flex><span>$ chmod <span style=color:#0000cf;font-weight:700>700</span> private
</span></span><span style=display:flex><span>$ touch index.txt
</span></span><span style=display:flex><span>$ <span style=color:#204a87>echo</span> <span style=color:#0000cf;font-weight:700>1000</span> &gt; serial
</span></span></code></pre></div><p>在中级 CA 证书目录下，新建名为 <code>crlnumber</code> 的文本文件，用于保存证书吊销列表：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#204a87>echo</span> <span style=color:#0000cf;font-weight:700>1000</span> &gt; /root/ca/intermediate/crlnumber
</span></span></code></pre></div><p>创建中级 CA 证书的签发配置文件，将中级 CA 证书的配置文件保存在 <code>/root/ca/intermediate/openssl.cnf</code> ，相比根证书配置文件修改了证书的保存目录：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[ CA_default ]
</span></span><span style=display:flex><span>dir             = /root/ca/intermediate
</span></span><span style=display:flex><span>private_key     = $dir/private/intermediate.key.pem
</span></span><span style=display:flex><span>certificate     = $dir/certs/intermediate.cert.pem
</span></span><span style=display:flex><span>crl             = $dir/crl/intermediate.crl.pem
</span></span><span style=display:flex><span>policy          = policy_loose
</span></span></code></pre></div><p>完整的配置文件内容如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#8f5902;font-style:italic># OpenSSL intermediate CA configuration file.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Copy to `/root/ca/intermediate/openssl.cnf`.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ca</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># `man ca`
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>default_ca</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CA_default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CA_default</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Directory and file locations.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>dir</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>ca</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>intermediate</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>certs</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>$</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>certs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>crl_dir</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>$</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>crl</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>new_certs_dir</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>$</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>newcerts</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>$</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>txt</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>serial</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>$</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>serial</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>RANDFILE</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>$</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>private</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rand</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># The root key and root certificate.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>private_key</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>$</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>private</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>intermediate</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pem</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>certificate</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>$</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>certs</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>intermediate</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cert</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pem</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># For certificate revocation lists.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>crlnumber</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>$</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>crlnumber</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>crl</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>$</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>crl</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>intermediate</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>crl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pem</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>crl_extensions</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>crl_ext</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>default_crl_days</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># SHA-1 is deprecated, so use SHA-2 instead.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>default_md</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sha256</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>name_opt</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ca_default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>cert_opt</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ca_default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>default_days</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>375</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>preserve</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>no</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>policy</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy_loose</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy_strict</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># The root CA should only sign intermediate certificates that match.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># See the POLICY FORMAT section of `man ca`.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>countryName</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>match</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>stateOrProvinceName</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>match</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>organizationName</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>match</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>organizationalUnitName</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>commonName</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>supplied</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>emailAddress</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy_loose</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Allow the intermediate CA to sign a more diverse range of certificates.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># See the POLICY FORMAT section of the `ca` man page.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>countryName</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>stateOrProvinceName</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>localityName</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>organizationName</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>organizationalUnitName</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>commonName</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>supplied</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>emailAddress</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>optional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>req</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Options for the `req` tool (`man req`).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>default_bits</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2048</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>distinguished_name</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>req_distinguished_name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>string_mask</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>utf8only</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># SHA-1 is deprecated, so use SHA-2 instead.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>default_md</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sha256</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Extension to add when the -x509 option is used.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>x509_extensions</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v3_ca</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>req_distinguished_name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># See &lt;https://en.wikipedia.org/wiki/Certificate_signing_request&gt;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>countryName</span><span style=color:#f8f8f8;text-decoration:underline>                     </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Country</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>letter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>code</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>stateOrProvinceName</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>State</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>or</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Province</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>localityName</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Locality</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>organizationName</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Organization</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>organizationalUnitName</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Organizational</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Unit</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>commonName</span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Common</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>emailAddress</span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Email</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Address</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Optionally, specify some defaults.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>countryName_default</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GB</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>stateOrProvinceName_default</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>England</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>localityName_default</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>organizationName_default</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Alice</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Ltd</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>organizationalUnitName_default</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>emailAddress_default</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v3_ca</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Extensions for a typical CA (`man x509v3_config`).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>subjectKeyIdentifier</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hash</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>authorityKeyIdentifier</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>keyid</span><span style=color:#000;font-weight:700>:</span><span style=color:#000>always</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>issuer</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>basicConstraints</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>critical</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CA</span><span style=color:#000;font-weight:700>:</span><span style=color:#000>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>keyUsage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>critical</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>digitalSignature</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cRLSign</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>keyCertSign</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v3_intermediate_ca</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Extensions for a typical intermediate CA (`man x509v3_config`).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>subjectKeyIdentifier</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hash</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>authorityKeyIdentifier</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>keyid</span><span style=color:#000;font-weight:700>:</span><span style=color:#000>always</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>issuer</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>basicConstraints</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>critical</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CA</span><span style=color:#000;font-weight:700>:</span><span style=color:#000>true</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pathlen</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>keyUsage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>critical</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>digitalSignature</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cRLSign</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>keyCertSign</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>usr_cert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Extensions for client certificates (`man x509v3_config`).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>basicConstraints</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CA</span><span style=color:#000;font-weight:700>:</span><span style=color:#000>FALSE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>nsCertType</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>email</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>nsComment</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;OpenSSL Generated Client Certificate&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>subjectKeyIdentifier</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hash</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>authorityKeyIdentifier</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>keyid</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>issuer</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>keyUsage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>critical</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nonRepudiation</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>digitalSignature</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>keyEncipherment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>extendedKeyUsage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clientAuth</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>emailProtection</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server_cert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Extensions for server certificates (`man x509v3_config`).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>basicConstraints</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CA</span><span style=color:#000;font-weight:700>:</span><span style=color:#000>FALSE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>nsCertType</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>nsComment</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;OpenSSL Generated Server Certificate&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>subjectKeyIdentifier</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hash</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>authorityKeyIdentifier</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>keyid</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>issuer</span><span style=color:#000;font-weight:700>:</span><span style=color:#000>always</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>keyUsage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>critical</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>digitalSignature</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>keyEncipherment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>extendedKeyUsage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>serverAuth</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>crl_ext</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Extension for CRLs (`man x509v3_config`).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>authorityKeyIdentifier</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>keyid</span><span style=color:#000;font-weight:700>:</span><span style=color:#000>always</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ocsp</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Extension for OCSP signing certificates (`man ocsp`).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>basicConstraints</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CA</span><span style=color:#000;font-weight:700>:</span><span style=color:#000>FALSE</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>subjectKeyIdentifier</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hash</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>authorityKeyIdentifier</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>keyid</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>issuer</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>keyUsage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>critical</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>digitalSignature</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>extendedKeyUsage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>critical</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OCSPSigning</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ol start=8><li>生成中级 CA 证书私钥</li></ol><p>创建中级证书私钥，使用 <code>AES-256</code> 加密：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#204a87>cd</span> /root/ca
</span></span><span style=display:flex><span>$ openssl genrsa -aes256 -out intermediate/private/intermediate.key.pem <span style=color:#0000cf;font-weight:700>4096</span>
</span></span><span style=display:flex><span>$ chmod <span style=color:#0000cf;font-weight:700>400</span> intermediate/private/intermediate.key.pem
</span></span></code></pre></div><ol start=9><li>生成中级 CA 证书签名请求</li></ol><p>使用 <code>intermediate.key.pem</code> 为生成中级 CA 证书签名请求，同时使用根证书对证书进行签名。注意 <code>Common Name</code> 不能重复。如果使用中级 CA 签发服务器证书和客户端证书，需要指定配置文件 <code>intermediate/openssl.cnf</code> ：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#204a87>cd</span> /root/ca
</span></span><span style=display:flex><span>$ openssl req -config intermediate/openssl.cnf -new sha256 -key intermediate/private/intermediate.key.pem -out intermediate/csr/intermediate.csr.pem
</span></span></code></pre></div><ol start=10><li>使用根证书生成中级 CA 证书</li></ol><p>使用根证书签发中级 CA 证书，并为其指定 <code>v3_intermediate_ca</code> 扩展属性签发证书，确认使用根证书的 <code>openssl.cnf</code> 签发中级证书，注意，中级 CA 证书的有效期要短于根证书。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#204a87>cd</span> /root/ca
</span></span><span style=display:flex><span>$ openssl ca -config openssl.cnf -extenstions v3_intermediate_ca -days <span style=color:#0000cf;font-weight:700>3650</span> -notext -md sha256 -in intermediate/csr/intermediate.csr.pem -out intermediate/certs/intermediate.cert.pem
</span></span><span style=display:flex><span>$ chmod <span style=color:#0000cf;font-weight:700>444</span> intermediate/certs/intermediate.cert.pem
</span></span></code></pre></div><blockquote><p>Note: <code>index.txt</code> 是 openssl 的文件数据库，不要直接修改或删除该文件。</p></blockquote><ol start=11><li>验证中级 CA 证书内容</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ openssl x509 -noout -text -in intermediate/certs/intermediate.cert.pem
</span></span></code></pre></div><p>使用根证书验证中级证书的证书链信任关系，<code>OK</code> 表示证书链受信任：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ openssl verify -CAfile certs/ca.cert.pem intermediate/certs/intermediate.cert.pem
</span></span><span style=display:flex><span>intermediate.cert.pem: OK
</span></span></code></pre></div><ol start=12><li>创建证书链文件</li></ol><p>当应用程序尝试验证签发的证书有效性时，会尝试验证中级 CA 证书和上级根证书。在证书链文件中，必须同时包含根证书和中级证书，因为客户端不知道签发证书使用的中级 CA证书的根证书，可以在所有需要访问的客户端将根证书导入到受信任的根证书机构中，这样该 CA 签发的证书就完全受信任并且证书链文件中则只用指定中级 CA 证书即可。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat intermediate/certs/intermediate.cert.pem certs/ca.cert.pem &gt; intermediate/certs/ca-chain.cert.pem
</span></span><span style=display:flex><span>$ chmod <span style=color:#0000cf;font-weight:700>444</span> intermediate/certs/ca-chain.cert.pem
</span></span></code></pre></div><h3 id=签发服务器证书和客户端证书>签发服务器证书和客户端证书</h3><p>接下来我们将使用中级 CA 证书为服务器签发证书，用来加密服务器与客户端之间的数据通信。如果在服务器使用 openssl 已经创建过了证书签发请求（CSR），则可跳过生成创建服务器证书私钥的过程。</p><ol><li>创建服务器证书私钥：</li></ol><p>在创建中级 CA 证书和根证书使用了 <code>4096bit</code> 密码加密，服务器和客户端证书一般有效期为几年，可以使用 <code>2048bit</code> 加密。虽然 <code>4096bit</code> 密码要更安全，但在服务器进行TLS握手和数字签名验证时会降低访问速度，因此一般 Web 服务器还是建议使用 <code>2048Bit</code> 密码加密。如果您在创建私钥时设置了密码，则每次服务重启时都需要提供这一密码，因此不建议为服务器证书设置密码保护，可以使用 <code>aes256</code> 密码算法进行加密：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#204a87>cd</span> /root/ca
</span></span><span style=display:flex><span>$ openssl genrsa -aes256 -out intermediate/private/mc.cn.key.pem <span style=color:#0000cf;font-weight:700>2048</span>
</span></span><span style=display:flex><span>$ chmod <span style=color:#0000cf;font-weight:700>400</span> intermediate/private/mc.cn.key.pem
</span></span></code></pre></div><ol start=2><li>创建服务器证书签发请求：</li></ol><p>使用创建的服务器私钥生成证书签发请求， 证书签发请求的 <code>csr</code> 文件无需指定中级 CA 证书机构，但是必须指定 <code>Common Name</code> ，一般为域名或 IP 地址：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#204a87>cd</span> /root/ca
</span></span><span style=display:flex><span>$ openssl req -config intermediate/openssl.cnf -new -sha256 -days <span style=color:#0000cf;font-weight:700>365</span> -key intermediate/private/mc.cn.key.pem -out intermediate/csr/mc.cn.csr.pem
</span></span></code></pre></div><ol start=2><li>从证书签发请求创建服务器证书：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#204a87>cd</span> /root/ca
</span></span><span style=display:flex><span>$ openssl ca -config intermediate/openssl.cnf <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>      -extensions server_cert -days <span style=color:#0000cf;font-weight:700>375</span> -notext -md sha256 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>      -in intermediate/csr/mc.cn.cert.pem <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>      -out intermediate/certs/mc.cn.cert.pem 
</span></span><span style=display:flex><span>$ chmod <span style=color:#0000cf;font-weight:700>444</span> intermediate/certs/mc.cn.cert.pem
</span></span></code></pre></div><blockquote><p>Note: 在签发证书时， <code>-extensions</code> 选项用于指定要签发的证书类型，通常，服务器证书使用 <code>server_cert</code> ，客户端证书使用 <code>usr_cert</code>。证书签发完毕后，将会在 <code>intermediate/index.txt</code> 文件中新增一条记录。</p></blockquote><ol start=4><li>查看签发的证书：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ openssl x509 -noout -text  -in intermediate/certs/mc.cn.cert.pem
</span></span></code></pre></div><p>使用 CA 证书链验证签发证书的信任关系：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ openssl verify -CAfile intermediate/certs/ca-chain.cert.pem intermediate/certs/mc.cn.cert.pem
</span></span></code></pre></div><ol start=5><li>部署证书</li></ol><p>在证书签发完毕后，可以将证书部署在应用服务器上了。</p><h2 id=总结>总结</h2><p>至此，我们完成了创建私有证书中心、中级证书、证书链以及颁发数字证书的全部过程，在实际的使用当中，还会面临证书的到期轮换问题，包括应用程序证书、中级证书以及根证书的到期更新问题。对于应用程序证书和中级证书的轮换更新问题不大，最主要是如何更新根证书，因为一旦根证书更新，所以基于根证书的证书都要更新。在进行根证书更新时，证书中心生成一对新的秘钥对和根证书，然后用新的私钥为旧的公钥签名生成一个中间证书，并用旧的私钥为新的公钥签名生成另外一个中间证书。这样，无论是新的根证书还是旧的根证书颁发的中间证书在更新期间都可以正常使用，从而实现新旧老根证书的平滑升级过渡。</p></div><div class="row middle-xs"><div class=col-xs-12><div class=post-category><a href=https://morven.life/categories/note/>note</a></div><div class=post-category><a href=https://morven.life/categories/tech/>tech</a></div></div></div><div class=row><div class=col-xs-12></div></div><div style=height:50px></div><div class=site-footer><div class=site-footer-item><a href=https://morven.life/about/ target=_blank>About Me</a></div></div></div></div></article><script src=https://morven.life/js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById("article")})</script><script></script></body></html>