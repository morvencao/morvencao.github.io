<!doctype html><html lang=en><meta charset=utf-8><meta name=generator content="Hugo 0.80.0"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Morven's Life"><meta property=og:url content=https://morven.life/posts/the_k8s_api-2/><link rel=canonical href=https://morven.life/posts/the_k8s_api-2/><link rel=apple-touch-icon href=https://morven.life/favicon.ico><link rel=icon href=https://morven.life/favicon.ico><link rel=shortcut href=https://morven.life/favicon.ico><link rel=alternate type=application/atom+xml href=https://morven.life/index.xml title="Morven's Life"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/morven.life\/"},"articleSection":"posts","name":"深入 kubernetes API 的源码实现","headline":"深入 kubernetes API 的源码实现","description":"很多同学应该像我一样，第一次打开 Github 上面 kubernetes 项目源码的时候就被各种仓库搞晕了，kuberentes 组织下有很多个仓库，包括 kubernetes、client-go、api、apimachinery 等，该从哪儿仓库看起？kubernetes 仓库应该是 kubernetes 项目的核心仓库，它包含 kubernetes 控制平面核心组件的源码；client-go 从名字也不难看出是操作 kubernetes API 的 go 语言客户端；api 与 apimachinery 应该是与 kubernetes API 相关的仓库，但它们俩为啥要分成两个不同的仓库？这些代码仓库之间如何交互？apimachinery仓库中还有 api、apis 两个包，里面定义了各种复杂的接口与实现，清楚这些复杂接口对于扩展 kubernetes API 大有裨益。所以，这篇文章就重点关注 api 与 apimachinery 这两个仓库。\napi 我们知道 kubernetes 官方提供了多种多样的的 API 资源类型，它们被定义在 k8s.io\/api 这个仓库中，作为 kubernetes API 定义的规范地址。实际上，最开始这个仓库只是 kubernetes 核心仓库的一部分，后来 kubernetes API 定义规范被越来越多的其他仓库使用，例如 k8s.io\/client-go、k8s.io\/apimachinery、k8s.io\/apiserver 等，为了避免交叉依赖，所以才把 api 拿出来作为单独的仓库。k8s.io\/api 仓库是只读仓库，所有代码都同步自 https:\/\/github.com\/kubernetes\/kubernetes\/blob\/master\/staging\/src\/k8s.io\/api 核心仓库。\n在 k8s.io\/api 仓库定义的kubernetes API 规范中，Pod 作为最基础的资源类型，一个典型的 YAML 形式的序列化 pod 对象如下所示：\napiVersion:v1kind:Podmetadata:name:webserverlabels:app:webserverspec:containers:- name:webserverimage:nginxports:- containerPort:80从编程的角度来看，序列化的 pod 对象最终会被发送到 API-Server 并解码为 Pod 类型的 Go 结构体，同时 YAML 中的各个字段会被赋值给该 Go 结构体。那么，Pod 类型在 Go 语言结构体中是怎么定义的呢？","inLanguage":"en-US","author":"Morven\u0027s Life","creator":"Morven\u0027s Life","publisher":"Morven\u0027s Life","accountablePerson":"Morven\u0027s Life","copyrightHolder":"Morven\u0027s Life","copyrightYear":"2021","datePublished":"2021-02-25 00:00:00 \u002b0000 UTC","dateModified":"2021-02-25 00:00:00 \u002b0000 UTC","url":"https:\/\/morven.life\/posts\/the_k8s_api-2\/","keywords":[]}</script><title>深入 kubernetes API 的源码实现</title><meta property=og:title content="深入 kubernetes API 的源码实现"><meta property=og:type content=article><meta property=og:description content="很多同学应该像我一样，第一次打开 Github 上面 kubernetes 项目源码的时候就被各种仓库搞晕了，kuberentes 组织下有很多个仓库，包括 kubernetes、client-go、api、apimachinery 等，该从哪儿仓库看起？kubernetes 仓库应该是 kubernetes 项目的核心仓库，它包含 kubernetes 控制平面核心组件的源码；client-go 从名字也不难看出是操作 kubernetes API 的 go 语言客户端；api 与 apimachinery 应该是与 kubernetes API 相关的仓库，但它们俩为啥要分成两个不同的仓库？这些代码仓库之间如何交互？apimachinery仓库中还有 api、apis 两个包，里面定义了各种复杂的接口与实现，清楚这些复杂接口对于扩展 kubernetes API 大有裨益。所以，这篇文章就重点关注 api 与 apimachinery 这两个仓库。
api 我们知道 kubernetes 官方提供了多种多样的的 API 资源类型，它们被定义在 k8s.io/api 这个仓库中，作为 kubernetes API 定义的规范地址。实际上，最开始这个仓库只是 kubernetes 核心仓库的一部分，后来 kubernetes API 定义规范被越来越多的其他仓库使用，例如 k8s.io/client-go、k8s.io/apimachinery、k8s.io/apiserver 等，为了避免交叉依赖，所以才把 api 拿出来作为单独的仓库。k8s.io/api 仓库是只读仓库，所有代码都同步自 https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api 核心仓库。
在 k8s.io/api 仓库定义的kubernetes API 规范中，Pod 作为最基础的资源类型，一个典型的 YAML 形式的序列化 pod 对象如下所示：
apiVersion:v1kind:Podmetadata:name:webserverlabels:app:webserverspec:containers:- name:webserverimage:nginxports:- containerPort:80从编程的角度来看，序列化的 pod 对象最终会被发送到 API-Server 并解码为 Pod 类型的 Go 结构体，同时 YAML 中的各个字段会被赋值给该 Go 结构体。那么，Pod 类型在 Go 语言结构体中是怎么定义的呢？"><meta name=description content="很多同学应该像我一样，第一次打开 Github 上面 kubernetes 项目源码的时候就被各种仓库搞晕了，kuberentes 组织下有很多个仓库，包括 kubernetes、client-go、api、apimachinery 等，该从哪儿仓库看起？kubernetes 仓库应该是 kubernetes 项目的核心仓库，它包含 kubernetes 控制平面核心组件的源码；client-go 从名字也不难看出是操作 kubernetes API 的 go 语言客户端；api 与 apimachinery 应该是与 kubernetes API 相关的仓库，但它们俩为啥要分成两个不同的仓库？这些代码仓库之间如何交互？apimachinery仓库中还有 api、apis 两个包，里面定义了各种复杂的接口与实现，清楚这些复杂接口对于扩展 kubernetes API 大有裨益。所以，这篇文章就重点关注 api 与 apimachinery 这两个仓库。
api 我们知道 kubernetes 官方提供了多种多样的的 API 资源类型，它们被定义在 k8s.io/api 这个仓库中，作为 kubernetes API 定义的规范地址。实际上，最开始这个仓库只是 kubernetes 核心仓库的一部分，后来 kubernetes API 定义规范被越来越多的其他仓库使用，例如 k8s.io/client-go、k8s.io/apimachinery、k8s.io/apiserver 等，为了避免交叉依赖，所以才把 api 拿出来作为单独的仓库。k8s.io/api 仓库是只读仓库，所有代码都同步自 https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api 核心仓库。
在 k8s.io/api 仓库定义的kubernetes API 规范中，Pod 作为最基础的资源类型，一个典型的 YAML 形式的序列化 pod 对象如下所示：
apiVersion:v1kind:Podmetadata:name:webserverlabels:app:webserverspec:containers:- name:webserverimage:nginxports:- containerPort:80从编程的角度来看，序列化的 pod 对象最终会被发送到 API-Server 并解码为 Pod 类型的 Go 结构体，同时 YAML 中的各个字段会被赋值给该 Go 结构体。那么，Pod 类型在 Go 语言结构体中是怎么定义的呢？"><meta property=og:locale content=en-us><style>body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:#000;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:#000}.markdown-body blockquote{background-color:#f8f8f8;border-left:2px solid;margin:40px;padding:10px 20px}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:#f6f8fa;border-radius:6px}.markdown-body pre>code{padding:0;font-size:85%;background-color:inherit;border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.signatures{font-family:permanent marker,Impact,Charcoal,sans-serif;font-size:3rem;margin-top:32px}.signatures a{text-decoration:none}.header-line{width:100%;height:3px;background-color:#000;margin:18px 0}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-date,.posts-title{font-size:1.2rem}.posts-line{margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px;margin-bottom:3px}.site-footer{margin-top:50px;margin-bottom:80px;display:flex;justify-content:flex-end;flex-wrap:wrap;padding:12px 0;border-width:3px;border-color:#000}.site-footer-item{margin-right:12px}@media screen and (max-width:600px){.site-header{display:none}.post-content{padding:0 12px}.post-content p{letter-spacing:.05em}}@media screen and (max-width:48em){.posts-category{display:none}}.post-content img{max-width:100%;display:block;margin-left:auto;margin-right:auto;margin-top:12px}.post-header{margin-bottom:50px}.post-title{font-size:2.5rem;font-weight:600}.post-category{display:inline;font-weight:900;margin:0 4px;padding:2px 5px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:0 1 auto;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link href=https://morven.life/index.xml rel=alternate type=application/rss+xml title="Morven's Life"><link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel=stylesheet><article class="post 简体中文" id=article><div class=row><div class=col-xs-12><header class=post-header><h1 class=post-title>深入 kubernetes API 的源码实现</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2021-02-25 00:00:00 UTC">25 Feb 2021</time></div><div class=col-xs-6><div class=post-author><a target=_blank href=https://morven.life/>@Morven's Life</a></div></div></div></header><div class="post-content markdown-body"><p>很多同学应该像我一样，第一次打开 Github 上面 kubernetes 项目源码的时候就被各种仓库搞晕了，kuberentes 组织下有很多个仓库，包括 kubernetes、client-go、api、apimachinery 等，该从哪儿仓库看起？kubernetes 仓库应该是 kubernetes 项目的核心仓库，它包含 kubernetes 控制平面核心组件的源码；client-go 从名字也不难看出是操作 kubernetes API 的 go 语言客户端；api 与 apimachinery 应该是与 kubernetes API 相关的仓库，但它们俩为啥要分成两个不同的仓库？这些代码仓库之间如何交互？apimachinery仓库中还有 api、apis 两个包，里面定义了各种复杂的接口与实现，清楚这些复杂接口对于扩展 kubernetes API 大有裨益。所以，这篇文章就重点关注 api 与 apimachinery 这两个仓库。<h2 id=api>api</h2><p>我们知道 kubernetes 官方提供了多种多样的的 API 资源类型，它们被定义在 k8s.io/api 这个仓库中，作为 kubernetes API 定义的规范地址。实际上，最开始这个仓库只是 kubernetes 核心仓库的一部分，后来 kubernetes API 定义规范被越来越多的其他仓库使用，例如 k8s.io/client-go、k8s.io/apimachinery、k8s.io/apiserver 等，为了避免交叉依赖，所以才把 api 拿出来作为单独的仓库。k8s.io/api 仓库是只读仓库，所有代码都同步自 <a href=https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api>https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api</a> 核心仓库。<p>在 k8s.io/api 仓库定义的kubernetes API 规范中，Pod 作为最基础的资源类型，一个典型的 YAML 形式的序列化 pod 对象如下所示：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Pod</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>webserver</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>webserver</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>webserver</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nginx</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>从编程的角度来看，序列化的 pod 对象最终会被发送到 API-Server 并解码为 Pod 类型的 Go 结构体，同时 YAML 中的各个字段会被赋值给该 Go 结构体。那么，Pod 类型在 Go 语言结构体中是怎么定义的呢？<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from https://github.com/kubernetes/api/blob/master/core/v1/types.go
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Pod</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 从TypeMeta字段名可以看出该字段定义Pod类型的元信息，类似于面向对象编程里面
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Class本身的元信息，类似于Pod类型的API分组、API版本等
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TypeMeta</span> <span style=color:#4e9a06>`json:&#34;,inline&#34;`</span>
    <span style=color:#8f5902;font-style:italic>// ObjectMeta字段定义单个Pod对象的元信息。每个kubernetes资源对象都有自己的元信息，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 例如名字、命名空间、标签、注释等等，kuberentes把这些公共的属性提取出来就是
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// metav1.ObjectMeta，成为了API对象类型的父类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ObjectMeta</span> <span style=color:#4e9a06>`json:&#34;metadata,omitempty&#34; protobuf:&#34;bytes,1,opt,name=metadata&#34;`</span>
    <span style=color:#8f5902;font-style:italic>// PodSpec表示Pod类型的对象定义规范，最为代表性的就是CPU、内存的资源使用。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 这个字段和YAML中spec字段对应
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Spec</span> <span style=color:#000>PodSpec</span> <span style=color:#4e9a06>`json:&#34;spec,omitempty&#34; protobuf:&#34;bytes,2,opt,name=spec&#34;`</span>
    <span style=color:#8f5902;font-style:italic>// PodStatus表示Pod的状态，比如是运行还是挂起、Pod的IP等等。Kubernetes会根据pod在
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 集群中的实际状态来更新PodStatus字段
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Status</span> <span style=color:#000>PodStatus</span> <span style=color:#4e9a06>`json:&#34;status,omitempty&#34; protobuf:&#34;bytes,3,opt,name=status&#34;`</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>从上面 Pod 定义的结构体可以看出，它继承了 metav1.TypeMeta 和 metav1.ObjectMeta 两个类型，metav1.TypeMeta 对应 YAML 中的 kind 与 apiVersion 段，而 metav1.ObjectMeta 则对应 metadata 字段。这其实也可以从 Go 结构体的字段 json 标签看得出来。除了 metav1.TypeMeta 和 metav1.ObjectMeta 字段，Pod 结构体同时还定义了 Spec 和 Status 两个成员变量。如果去查看 k8s.io/api 仓库中其他 API 资源结构体的定义就会发现 kubernetes 绝大部分 API 资源类型都是这样的结构，这也就是说 kubernetes API 资源类型都继承 metav1.TypeMeta 和 metav1.ObjectMeta，前者用于定义资源类型的属性，后者用于定义资源对象的公共属性；Spec 用于定义 API 资源类型的私有属性，也是不同 API 资源类型之间的区别所在；Status 则是用于描述每个资源对象的状态，这和每个资源类型紧密相关的。<p>关于 metav1.TypeMeta 和 metav1.ObjectMeta 字段从语义上也很好理解，这两个类型作为所有 kubernetes API 资源对象的基类，每个 API 资源对象需要 metav1.TypeMeta 字段用于描述自己是什么类型，这样才能构造相应类型的对象，所以相同类型的所有资源对象的 metav1.TypeMeta 字段都是相同的，但是 metav1.ObjectMeta 则不同，它是定义资源对象实例的属性，即所有资源对象都应该具备的属性。这部分就是和对象本身相关，和类型无关，所以相同类型的资源对象的 metav1.ObjectMeta 可能是不同的。<p>在 kubernetes 的 API 资源对象中除了单体对象外，还有对象列表类型，用于描述一组相同类型的对象列表。对象列表的典型应用场景就是列举，对象列表就可以表达一组资源对象。可能有些读者会问为什么不用对象的slice，例如[]Pod，伴随着笔者对对象列表的解释读者就会理解，此处以PodList为例进行分析：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from https://github.com/kubernetes/api/blob/master/core/v1/types.go
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>PodList</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// PodList也需要继承metav1.TypeMeta，毕竟对象列表也好、单体对象也好都需要类型属性。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// PodList比[]Pod类型在yaml或者json表达上多了类型描述，当需要根据YAML构建对象列表的时候，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 就可以根据类型描述反序列成为PodList。而[]Pod则不可以，必须确保YAML就是[]Pod序列化的
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 结果，否则就会报错。这就无法实现一个通用的对象序列化/反序列化。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TypeMeta</span> <span style=color:#4e9a06>`json:&#34;,inline&#34;`</span>
    <span style=color:#8f5902;font-style:italic>// 与Pod不同，PodList继承了metav1.ListMeta，metav1.ListMeta是所有资源对象列表类型的父类，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// ListMeta定义了所有对象列表类型实例的公共属性。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ListMeta</span> <span style=color:#4e9a06>`json:&#34;metadata,omitempty&#34; protobuf:&#34;bytes,1,opt,name=metadata&#34;`</span>
    <span style=color:#8f5902;font-style:italic>// Items字段则是PodList定义的本质，表示Pod资源对象的列表，所以说PodList就是[]Pod基础上加了一些
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 跟类型和对象列表相关的元信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Items</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>Pod</span> <span style=color:#4e9a06>`json:&#34;items&#34; protobuf:&#34;bytes,2,rep,name=items&#34;`</span>
</code></pre></div><p>在开始下一节的内容之前，我们先做个小结：<ol><li>metav1.TypeMeta 和 metav1.ObjectMeta 是所有 API 单体资源对象的父类；<li>metav1.TypeMeta 和 metav1.ListMeta 是所有 API 资源对象列表的父类；<li>metav1.TypeMeta 是所有 API 资源对象的父类，因为所有的资源对象都要说明表示是什么类型；</ol><h2 id=metav1>metav1</h2><p>这里的 metav1 是包 k8s.io/apimachinery/pkg/apis/meta/v1 的别名，本文其他部分的将用 metav1 指代。<h3 id=metav1typemeta>metav1.TypeMeta</h3><p>metav1.TypeMeta 用来描述 kubernetes API 资源对象类型的元信息，包括资源类型的名字以及对应 API 的 schema。这里的 schema 指的是资源类型 API 分组以及版本。<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from https://github.com/kubernetes/apimachinery/blob/master/pkg/apis/meta/v1/types.go
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>// TypeMeta describes an individual object in an API response or request
</span><span style=color:#8f5902;font-style:italic>// with strings representing the type of the object and its API schema version.
</span><span style=color:#8f5902;font-style:italic>// Structures that are versioned or persisted should inline TypeMeta.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>TypeMeta</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// Kind is a string value representing the REST resource this object represents.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Servers may infer this from the endpoint the client submits requests to.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Cannot be updated.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Kind</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;kind,omitempty&#34; protobuf:&#34;bytes,1,opt,name=kind&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// APIVersion defines the versioned schema of this representation of an object.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Servers should convert recognized schemas to the latest internal value, and
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// may reject unrecognized values.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>APIVersion</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;apiVersion,omitempty&#34; protobuf:&#34;bytes,2,opt,name=apiVersion&#34;`</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>细心的同学还会发现 metav1.TypeMeta 实现了 schema.ObjectKind 接口，schema.ObjectKind 接口了所有序列化对象怎么解码与编码资源类型信息的方法，它的完整定义如下：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from https://github.com/kubernetes/apimachinery/blob/master/pkg/runtime/schema/interfaces.go
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>// All objects that are serialized from a Scheme encode their type information. This interface is used
</span><span style=color:#8f5902;font-style:italic>// by serialization to set type information from the Scheme onto the serialized version of an object.
</span><span style=color:#8f5902;font-style:italic>// For objects that cannot be serialized or have unique requirements, this interface may be a no-op.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ObjectKind</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// SetGroupVersionKind sets or clears the intended serialized kind of an object. Passing kind nil
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// should clear the current setting.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>SetGroupVersionKind</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>kind</span> <span style=color:#000>GroupVersionKind</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#8f5902;font-style:italic>// GroupVersionKind returns the stored group, version, and kind of an object, or an empty struct
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// if the object does not expose or provide these fields.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>GroupVersionKind</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>GroupVersionKind</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>从 metav1.TypeMeta 对象的实例（也就是任何 kubernetes API 资源对象）都可以通过 <code>GetObjectKind()</code> 方法获取到 schema.ObjectKind 类型对象，而 TypeMeta 对象的实例本身也实现了 schema.ObjectKind 接口：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from https://github.com/kubernetes/apimachinery/blob/master/pkg/apis/meta/v1/types.go
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>TypeMeta</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>GetObjectKind</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ObjectKind</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>obj</span> <span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// SetGroupVersionKind satisfies the ObjectKind interface for all objects that embed TypeMeta
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>TypeMeta</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>SetGroupVersionKind</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>gvk</span> <span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GroupVersionKind</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>APIVersion</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Kind</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>gvk</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ToAPIVersionAndKind</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// GroupVersionKind satisfies the ObjectKind interface for all objects that embed TypeMeta
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>TypeMeta</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>GroupVersionKind</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GroupVersionKind</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FromAPIVersionAndKind</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>APIVersion</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Kind</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=metav1objectmeta>metav1.ObjectMeta</h3><p>metav1.ObjectMeta 则用来定义资源对象实例的属性，即所有资源对象都应该具备的属性。这部分就是和对象本身相关，和类型无关，所以相同类型的资源对象的 metav1.ObjectMeta 可能是不同的。<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from https://github.com/kubernetes/apimachinery/blob/master/pkg/apis/meta/v1/types.go
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>// ObjectMeta is metadata that all persisted resources must have, which includes all objects
</span><span style=color:#8f5902;font-style:italic>// users must create.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ObjectMeta</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// Name must be unique within a namespace. Is required when creating resources, although
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// some resources may allow a client to request the generation of an appropriate name
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// automatically. Name is primarily intended for creation idempotence and configuration
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// definition.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Name</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;name,omitempty&#34; protobuf:&#34;bytes,1,opt,name=name&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// GenerateName is an optional prefix, used by the server, to generate a unique
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// name ONLY IF the Name field has not been provided.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Populated by the system. Read-only.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>GenerateName</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;generateName,omitempty&#34; protobuf:&#34;bytes,2,opt,name=generateName&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// Namespace defines the space within which each name must be unique. An empty namespace is
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// equivalent to the &#34;default&#34; namespace, but &#34;default&#34; is the canonical representation.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Not all objects are required to be scoped to a namespace - the value of this field for
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// those objects will be empty.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Namespace</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;namespace,omitempty&#34; protobuf:&#34;bytes,3,opt,name=namespace&#34;`</span>

    <span style=color:#8f5902;font-style:italic>// SelfLink is a URL representing this object.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Populated by the system. Read-only.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>SelfLink</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;selfLink,omitempty&#34; protobuf:&#34;bytes,4,opt,name=selfLink&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// UID is the unique in time and space value for this object. It is typically generated by
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// the server on successful creation of a resource and is not allowed to change on PUT
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// operations.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Populated by the system. Read-only.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>UID</span> <span style=color:#000>types</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UID</span> <span style=color:#4e9a06>`json:&#34;uid,omitempty&#34; protobuf:&#34;bytes,5,opt,name=uid,casttype=k8s.io/kubernetes/pkg/types.UID&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// An opaque value that represents the internal version of this object that can
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// be used by clients to determine when objects have changed. May be used for optimistic
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// concurrency, change detection, and the watch operation on a resource or set of resources.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Clients must treat these values as opaque and passed unmodified back to the server.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// They may only be valid for a particular resource or set of resources.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Populated by the system. Read-only.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ResourceVersion</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;resourceVersion,omitempty&#34; protobuf:&#34;bytes,6,opt,name=resourceVersion&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// A sequence number representing a specific generation of the desired state.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Populated by the system. Read-only.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Generation</span> <span style=color:#204a87;font-weight:700>int64</span> <span style=color:#4e9a06>`json:&#34;generation,omitempty&#34; protobuf:&#34;varint,7,opt,name=generation&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// CreationTimestamp is a timestamp representing the server time when this object was
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// created. It is not guaranteed to be set in happens-before order across separate operations.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Clients may not set this value. It is represented in RFC3339 form and is in UTC.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Populated by the system. Read-only.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>CreationTimestamp</span> <span style=color:#000>Time</span> <span style=color:#4e9a06>`json:&#34;creationTimestamp,omitempty&#34; protobuf:&#34;bytes,8,opt,name=creationTimestamp&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// DeletionTimestamp is RFC 3339 date and time at which this resource will be deleted. This
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// field is set by the server when a graceful deletion is requested by the user, and is not
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// directly settable by a client. The resource is expected to be deleted (no longer visible
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// from resource lists, and not reachable by name) after the time in this field, once the
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// finalizers list is empty. As long as the finalizers list contains items, deletion is blocked.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Once the deletionTimestamp is set, this value may not be unset or be set further into the
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// future, although it may be shortened or the resource may be deleted prior to this time.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// For example, a user may request that a pod is deleted in 30 seconds. The Kubelet will react
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// by sending a graceful termination signal to the containers in the pod. After that 30 seconds,
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// the Kubelet will send a hard termination signal (SIGKILL) to the container and after cleanup,
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// remove the pod from the API. In the presence of network partitions, this object may still
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// exist after this timestamp, until an administrator or automated process can determine the
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// resource is fully terminated.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// If not set, graceful deletion of the object has not been requested.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Populated by the system when a graceful deletion is requested.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Read-only.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>DeletionTimestamp</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Time</span> <span style=color:#4e9a06>`json:&#34;deletionTimestamp,omitempty&#34; protobuf:&#34;bytes,9,opt,name=deletionTimestamp&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// Number of seconds allowed for this object to gracefully terminate before
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// it will be removed from the system. Only set when deletionTimestamp is also set.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// May only be shortened.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Read-only.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>DeletionGracePeriodSeconds</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#204a87;font-weight:700>int64</span> <span style=color:#4e9a06>`json:&#34;deletionGracePeriodSeconds,omitempty&#34; protobuf:&#34;varint,10,opt,name=deletionGracePeriodSeconds&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// Map of string keys and values that can be used to organize and categorize
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// (scope and select) objects. May match selectors of replication controllers
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// and services.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Labels</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;labels,omitempty&#34; protobuf:&#34;bytes,11,rep,name=labels&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// Annotations is an unstructured key value map stored with a resource that may be
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// set by external tools to store and retrieve arbitrary metadata. They are not
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// queryable and should be preserved when modifying objects.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Annotations</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;annotations,omitempty&#34; protobuf:&#34;bytes,12,rep,name=annotations&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// List of objects depended by this object. If ALL objects in the list have
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// been deleted, this object will be garbage collected. If this object is managed by a controller,
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// then an entry in this list will point to this controller, with the controller field set to true.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>OwnerReferences</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>OwnerReference</span> <span style=color:#4e9a06>`json:&#34;ownerReferences,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;uid&#34; protobuf:&#34;bytes,13,rep,name=ownerReferences&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// Must be empty before the object is deleted from the registry. Each entry
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// is an identifier for the responsible component that will remove the entry
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// from the list. If the deletionTimestamp of the object is non-nil, entries
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// in this list can only be removed.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Finalizers may be processed and removed in any order.  Order is NOT enforced
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// because it introduces significant risk of stuck finalizers.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// finalizers is a shared field, any actor with permission can reorder it.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// If the finalizer list is processed in order, then this can lead to a situation
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// in which the component responsible for the first finalizer in the list is
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// waiting for a signal (field value, external system, or other) produced by a
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// component responsible for a finalizer later in the list, resulting in a deadlock.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Without enforced ordering finalizers are free to order amongst themselves and
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// are not vulnerable to ordering changes in the list.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Finalizers</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;finalizers,omitempty&#34; patchStrategy:&#34;merge&#34; protobuf:&#34;bytes,14,rep,name=finalizers&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// The name of the cluster which the object belongs to.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// This is used to distinguish resources with same name and namespace in different clusters.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// This field is not set anywhere right now and apiserver is going to ignore it if set in create or update request.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ClusterName</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;clusterName,omitempty&#34; protobuf:&#34;bytes,15,opt,name=clusterName&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// ManagedFields maps workflow-id and version to the set of fields
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// that are managed by that workflow. This is mostly for internal
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// housekeeping, and users typically shouldn&#39;t need to set or
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// understand this field. A workflow can be the user&#39;s name, a
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// controller&#39;s name, or the name of a specific apply path like
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// &#34;ci-cd&#34;. The set of fields is always in the version that the
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// workflow used when modifying the object.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ManagedFields</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>ManagedFieldsEntry</span> <span style=color:#4e9a06>`json:&#34;managedFields,omitempty&#34; protobuf:&#34;bytes,17,rep,name=managedFields&#34;`</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>metav1.ObjectMeta 还实现了 metav1.Object 与 metav1.MetaAccessor 这两个接口，其中 metav1.Object 接口定义了获取单个资源对象各种元信息的 Get 与 Set 方法：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from https://github.com/kubernetes/apimachinery/blob/master/pkg/apis/meta/v1/meta.go
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>// Object lets you work with object metadata from any of the versioned or
</span><span style=color:#8f5902;font-style:italic>// internal API objects. Attempting to set or retrieve a field on an object that does
</span><span style=color:#8f5902;font-style:italic>// not support that field (Name, UID, Namespace on lists) will be a no-op and return
</span><span style=color:#8f5902;font-style:italic>// a default value.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Object</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>GetNamespace</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>string</span>
	<span style=color:#000>SetNamespace</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>namespace</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetName</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>string</span>
	<span style=color:#000>SetName</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetGenerateName</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>string</span>
	<span style=color:#000>SetGenerateName</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetUID</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>types</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UID</span>
	<span style=color:#000>SetUID</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uid</span> <span style=color:#000>types</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UID</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetResourceVersion</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>string</span>
	<span style=color:#000>SetResourceVersion</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>version</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetGeneration</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>int64</span>
	<span style=color:#000>SetGeneration</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>generation</span> <span style=color:#204a87;font-weight:700>int64</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetSelfLink</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>string</span>
	<span style=color:#000>SetSelfLink</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>selfLink</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetCreationTimestamp</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>Time</span>
	<span style=color:#000>SetCreationTimestamp</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>timestamp</span> <span style=color:#000>Time</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetDeletionTimestamp</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Time</span>
	<span style=color:#000>SetDeletionTimestamp</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>timestamp</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Time</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetDeletionGracePeriodSeconds</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#204a87;font-weight:700>int64</span>
	<span style=color:#000>SetDeletionGracePeriodSeconds</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#204a87;font-weight:700>int64</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetLabels</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>string</span>
	<span style=color:#000>SetLabels</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>labels</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetAnnotations</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>string</span>
	<span style=color:#000>SetAnnotations</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>annotations</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetFinalizers</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>string</span>
	<span style=color:#000>SetFinalizers</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>finalizers</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetOwnerReferences</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>OwnerReference</span>
	<span style=color:#000>SetOwnerReferences</span><span style=color:#000;font-weight:700>([]</span><span style=color:#000>OwnerReference</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetClusterName</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>string</span>
	<span style=color:#000>SetClusterName</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>clusterName</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetManagedFields</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>ManagedFieldsEntry</span>
	<span style=color:#000>SetManagedFields</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>managedFields</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>ManagedFieldsEntry</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>metav1.MetaAccessor 接口则定义了获取资源对象存取器的方法：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from https://github.com/kubernetes/apimachinery/blob/master/pkg/apis/meta/v1/meta.go
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ObjectMetaAccessor</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>GetObjectMeta</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>Object</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>因为 kubernetes 所有单体资源对象都继承了 metav1.ObjectMeta，那么所有的 API 资源对象就都实现了 metav1.Object 和 metav1.MetaAccessor 接口。kubernetes 中有很多地方访问 API 资源对象的元信息并且不区分对象类型，只要是 metav1.Object 接口类型的对象都可以访问。<h3 id=metav1listmeta>metav1.ListMeta</h3><p>metav1.ListMeta 定义了所有对象列表类型实例的公共属性。<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from https://github.com/kubernetes/apimachinery/blob/master/pkg/apis/meta/v1/types.go
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>// ListMeta describes metadata that synthetic resources must have, including lists and
</span><span style=color:#8f5902;font-style:italic>// various status objects. A resource may have only one of {ObjectMeta, ListMeta}.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ListMeta</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// selfLink is a URL representing this object.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Populated by the system.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Read-only.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>SelfLink</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;selfLink,omitempty&#34; protobuf:&#34;bytes,1,opt,name=selfLink&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// String that identifies the server&#39;s internal version of this object that
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// can be used by clients to determine when objects have changed.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Value must be treated as opaque by clients and passed unmodified back to the server.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Populated by the system.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Read-only.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ResourceVersion</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;resourceVersion,omitempty&#34; protobuf:&#34;bytes,2,opt,name=resourceVersion&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// continue may be set if the user set a limit on the number of items returned, and indicates that
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// the server has more data available. The value is opaque and may be used to issue another request
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// to the endpoint that served this list to retrieve the next set of available objects. Continuing a
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// consistent list may not be possible if the server configuration has changed or more than a few
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// minutes have passed. The resourceVersion field returned when using this continue value will be
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// identical to the value in the first response, unless you have received this token from an error
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// message.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Continue</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;continue,omitempty&#34; protobuf:&#34;bytes,3,opt,name=continue&#34;`</span>

	<span style=color:#8f5902;font-style:italic>// remainingItemCount is the number of subsequent items in the list which are not included in this
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// list response. If the list request contained label or field selectors, then the number of
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// remaining items is unknown and the field will be left unset and omitted during serialization.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// If the list is complete (either because it is not chunking or because this is the last chunk),
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// then there are no more remaining items and this field will be left unset and omitted during
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// serialization.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Servers older than v1.15 do not set this field.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// The intended use of the remainingItemCount is *estimating* the size of a collection. Clients
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// should not rely on the remainingItemCount to be set or to be exact.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>RemainingItemCount</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#204a87;font-weight:700>int64</span> <span style=color:#4e9a06>`json:&#34;remainingItemCount,omitempty&#34; protobuf:&#34;bytes,4,opt,name=remainingItemCount&#34;`</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>类似于与 metav1.ObjectMeta 结构体，metav1.ListMeta 还实现了 metav1.ListInterface 与 metav1.ListMetaAccessor 这两个接口，其中 metav1.ListInterface 接口定义了获取资源对象列表各种元信息的 Get 与 Set 方法：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from https://github.com/kubernetes/apimachinery/blob/master/pkg/apis/meta/v1/meta.go
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>// ListInterface lets you work with list metadata from any of the versioned or
</span><span style=color:#8f5902;font-style:italic>// internal API objects. Attempting to set or retrieve a field on an object that does
</span><span style=color:#8f5902;font-style:italic>// not support that field will be a no-op and return a default value.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ListInterface</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>GetResourceVersion</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>string</span>
	<span style=color:#000>SetResourceVersion</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>version</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetSelfLink</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>string</span>
	<span style=color:#000>SetSelfLink</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>selfLink</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetContinue</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>string</span>
	<span style=color:#000>SetContinue</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>GetRemainingItemCount</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#204a87;font-weight:700>int64</span>
	<span style=color:#000>SetRemainingItemCount</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#204a87;font-weight:700>int64</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>metav1.ListMetaAccessor 接口则定义了获取资源对象列表存取器的方法：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from https://github.com/kubernetes/apimachinery/blob/master/pkg/apis/meta/v1/meta.go
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>// ListMetaAccessor retrieves the list interface from an object
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ListMetaAccessor</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>GetListMeta</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>ListInterface</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=runtimeobject>runtime.Object</h3><p>前面在介绍 metav1.TypeMeta 与 metav1.ObjectMeta 的时候我们发现 schema.ObjecKind 是所有 API 资源类型的抽象，metav1.Object 是所有 API 单体资源对象属性的抽象，那么同时实现这两个接口的类型对象不就可以访问任何 API 对象的公共属性了吗？是的，对于每一个特定的类型，如 Pod、Deployment 等，它们确实可以获取当前 API 对象的公共属性。有没有一种所有特定类型的统一父类，同时拥有 schema.ObjecKind 和 metav1.Object 两个接口，这样就可以表示任何特定类型的对象。这就是本节要讨论 runtime.Object 接口。<p>先来看看 runtime.Object 接口定义：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from: https://github.com/kubernetes/apimachinery/blob/master/pkg/runtime/interfaces.go
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>// Object interface must be supported by all API types registered with Scheme. Since objects in a scheme are
</span><span style=color:#8f5902;font-style:italic>// expected to be serialized to the wire, the interface an Object must provide to the Scheme allows
</span><span style=color:#8f5902;font-style:italic>// serializers to set the kind, version, and group the object is represented as. An Object may choose
</span><span style=color:#8f5902;font-style:italic>// to return a no-op ObjectKindAccessor in cases where it is not expected to be serialized.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Object</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// used to access type metadata(GVK)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>GetObjectKind</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ObjectKind</span>
    <span style=color:#8f5902;font-style:italic>// DeepCopyObject needed to implemented by each kubernetes API type definition,
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// usually by automatically generated code.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>DeepCopyObject</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>Object</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>为什么 runtime.Object 接口只有这两个方法，不应该有 GetObjectMeta() 方法来获取 metav1.ObjectMeta 对象吗？仔细往下看的话会发现，这里使用了不一样的实现方式：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from: https://github.com/kubernetes/apimachinery/blob/master/pkg/api/meta/meta.go
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>// Accessor takes an arbitrary object pointer and returns meta.Interface.
</span><span style=color:#8f5902;font-style:italic>// obj must be a pointer to an API type. An error is returned if the minimum
</span><span style=color:#8f5902;font-style:italic>// required fields are missing. Fields that are not required return the default
</span><span style=color:#8f5902;font-style:italic>// value and are a no-op if set.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>Accessor</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>obj</span> <span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{})</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Object</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>switch</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>obj</span><span style=color:#000;font-weight:700>.(</span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Object</span><span style=color:#000;font-weight:700>:</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>t</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>nil</span>
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ObjectMetaAccessor</span><span style=color:#000;font-weight:700>:</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>t</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GetObjectMeta</span><span style=color:#000;font-weight:700>();</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>m</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>nil</span>
		<span style=color:#000;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>errNotObject</span>
	<span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>errNotObject</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>Accessor 方法可以讲任何的类型 metav1.Object 或者返回错误信息，这样就避免了每个 API 资源类型都需要实现 GetObjectMeta() 方法了。<p>还有个问题是为什么没有看到 API 资源类型实现 runtime.Object.DeepCopyObject() 方法？那是因为深拷贝方法是具体 API 资源类型需要重载实现的，存在类型依赖，作为 API 资源类型的父类不能统一实现。一般来说，深拷贝方法是由工具自动生成的，定义在 <code>zz_generated.deepcopy.go</code> 文件中，以 configMap 为例：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from https://github.com/kubernetes/api/blob/master/core/v1/zz_generated.deepcopy.go
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>// DeepCopyObject is an autogenerated deepcopy function, copying the receiver, creating a new runtime.Object.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ConfigMap</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>DeepCopyObject</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Object</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>in</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DeepCopy</span><span style=color:#000;font-weight:700>();</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>c</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=metav1unstructured>metav1.Unstructured</h3><p>metav1.Unstructured 与具体实现 rutime.Object 接口的类型（如 Pod、Deployment、Service 等等）不同，如果说，各个实现 rutime.Object 接口的类型主要用于 <a href=https://github.com/kubernetes/client-go>client-go</a> 类型化的静态客户端，那么 metav1.Unstructured 则用于动态客户端。<p>在看 metav1.Unstructured 源码实现之前，我们先了解一下什么是结构化数据与非结构化数据。结构化数据，顾名思义，就是数据中的字段名与字段值都是固定的，例如一个 JSON 格式的字符串表示一个学生的信息：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
    
	<span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>101</span><span style=color:#000;font-weight:700>,</span>
	<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Tom&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>定义这个学生的数据格式中的字段名与字段值都是固定的，我们很容易使用 Go 语言写出一个 struct 结构来表示这个学生的信息，各个字段意义明确：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Student</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
    
	<span style=color:#000>ID</span> <span style=color:#204a87;font-weight:700>int</span>
	<span style=color:#000>Name</span> <span style=color:#000>String</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>实际的情况是，一个格式化的字符串里面可能会包含很多编译时未知的信息，这些信息只有在运行时才能获取到。例如，上面的学生的数据中还包括第三个字段，该字段的类型和内容代码编译时未知，到运行时才可以获取具体的值。如何处理这种情况呢？熟悉反射的同学很快就应该想到，Go 语言可以依赖于反射机制在运行时动态获取各个字段，在编译阶段，我们将这些未知的类型统一为 <code>interface{}</code>。正是基于此，metav1.Unstructured 的数据结构定义很简单：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// soure code from: https://github.com/kubernetes/apimachinery/blob/master/pkg/apis/meta/v1/unstructured/unstructured.go
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Unstructured</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
    
	<span style=color:#8f5902;font-style:italic>// Object is a JSON compatible map with string, float, int, bool, []interface{}, or
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// map[string]interface{} children.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Object</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>事实上，metav1.Unstructured 是 apimachinery 中 runtime.Unstructured 接口的具体实现，runtime.Unstructured 接口定义了非结构化数据的操作接口方法列表，它提供程序来处理资源的通用属性，例如 metadata.namespace 等。<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// soure code from: https://github.com/kubernetes/apimachinery/blob/master/pkg/runtime/interfaces.go
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>// Unstructured objects store values as map[string]interface{}, with only values that can be serialized
</span><span style=color:#8f5902;font-style:italic>// to JSON allowed.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Unstructured</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>Object</span>
	<span style=color:#8f5902;font-style:italic>// NewEmptyInstance returns a new instance of the concrete type containing only kind/apiVersion and no other data.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// This should be called instead of reflect.New() for unstructured types because the go type alone does not preserve kind/apiVersion info.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>NewEmptyInstance</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>Unstructured</span>
	<span style=color:#8f5902;font-style:italic>// UnstructuredContent returns a non-nil map with this object&#39;s contents. Values may be
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// []interface{}, map[string]interface{}, or any primitive type. Contents are typically serialized to
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// and from JSON. SetUnstructuredContent should be used to mutate the contents.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>UnstructuredContent</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{}</span>
	<span style=color:#8f5902;font-style:italic>// SetUnstructuredContent updates the object content to match the provided map.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>SetUnstructuredContent</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{})</span>
	<span style=color:#8f5902;font-style:italic>// IsList returns true if this type is a list or matches the list convention - has an array called &#34;items&#34;.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>IsList</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>bool</span>
	<span style=color:#8f5902;font-style:italic>// EachListItem should pass a single item out of the list as an Object to the provided function. Any
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// error should terminate the iteration. If IsList() returns false, this method should return an error
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// instead of calling the provided function.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>EachListItem</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>只有 metav1.Unstructured 的定义并不能发挥什么作用，真正重要的是其实现的方法，借助这些方法可以灵活的处理非结构化数据。metav1.Unstructured 实现了存取类型元信息与对象元信息的方法，除此之外，它也实现了 runtime.Unstructured 接口中的所有方法。<p>基于这些方法，我们可以构建操作 kubernetes 资源的动态客户端，不需要使用 k8s.io/api 中定义的 Go 类型，使用 metav1.Unstructured 非结构化直接解码是 YAML/JSON 对象表示形式；非结构化数据编码时生成的 JSON/YAML 外也不会添加额外的字段。<p>以下示例演示了如何将 YAML 清单读为非结构化，非结构化并将其编码回 JSON：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
    <span style=color:#4e9a06>&#34;encoding/json&#34;</span>
    <span style=color:#4e9a06>&#34;fmt&#34;</span>
    <span style=color:#4e9a06>&#34;os&#34;</span>

    <span style=color:#4e9a06>&#34;k8s.io/apimachinery/pkg/apis/meta/v1/unstructured&#34;</span>
    <span style=color:#4e9a06>&#34;k8s.io/apimachinery/pkg/runtime/serializer/yaml&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>dsManifest</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>`
</span><span style=color:#4e9a06>apiVersion: apps/v1
</span><span style=color:#4e9a06>kind: DaemonSet
</span><span style=color:#4e9a06>metadata:
</span><span style=color:#4e9a06>  name: example
</span><span style=color:#4e9a06>  namespace: default
</span><span style=color:#4e9a06>spec:
</span><span style=color:#4e9a06>  selector:
</span><span style=color:#4e9a06>    matchLabels:
</span><span style=color:#4e9a06>      name: nginx-ds
</span><span style=color:#4e9a06>  template:
</span><span style=color:#4e9a06>    metadata:
</span><span style=color:#4e9a06>      labels:
</span><span style=color:#4e9a06>        name: nginx-ds
</span><span style=color:#4e9a06>    spec:
</span><span style=color:#4e9a06>      containers:
</span><span style=color:#4e9a06>      - name: nginx
</span><span style=color:#4e9a06>        image: nginx:latest
</span><span style=color:#4e9a06>`</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>unstructured</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Unstructured</span><span style=color:#000;font-weight:700>{}</span>

    <span style=color:#8f5902;font-style:italic>// decode YAML into unstructured.Unstructured
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>dec</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>yaml</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewDecodingSerializer</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>unstructured</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UnstructuredJSONScheme</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>gvk</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>dec</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Decode</span><span style=color:#000;font-weight:700>([]</span><span style=color:#204a87>byte</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dsManifest</span><span style=color:#000;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>obj</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#8f5902;font-style:italic>// Get the common metadata, and show GVK
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Println</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GetName</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>gvk</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>String</span><span style=color:#000;font-weight:700>())</span>

    <span style=color:#8f5902;font-style:italic>// encode back to JSON
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>enc</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>json</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewEncoder</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>os</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Stdout</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>enc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SetIndent</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;    &#34;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>enc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Encode</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>obj</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>程序的输出如下：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=color:#a40000>example</span> <span style=color:#a40000>apps/v</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#a40000>,</span> <span style=color:#a40000>Kind=DaemonSet</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;apiVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;kind&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;DaemonSet&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;metadata&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;example&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;namespace&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;default&#34;</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#204a87;font-weight:700>&#34;spec&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;selector&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;matchLabels&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;nginx-ds&#34;</span>
            <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000;font-weight:700>},</span>
        <span style=color:#204a87;font-weight:700>&#34;template&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;metadata&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>&#34;labels&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;nginx-ds&#34;</span>
                <span style=color:#000;font-weight:700>}</span>
            <span style=color:#000;font-weight:700>},</span>
            <span style=color:#204a87;font-weight:700>&#34;spec&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>&#34;containers&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
                    <span style=color:#000;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>&#34;image&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;nginx:latest&#34;</span><span style=color:#000;font-weight:700>,</span>
                        <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;nginx&#34;</span>
                    <span style=color:#000;font-weight:700>}</span>
                <span style=color:#000;font-weight:700>]</span>
            <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>此外，通过 Go 语言的反射机制可以实现 metav1.Unstructured 对象与具体资源对象的相互转换，runtime.unstructuredConverter 接口定义了 metav1.Unstructured 对象与具体资源对象的相互转换方法，并且内置了 runtime.DefaultUnstructuredConverter 实现了 runtime.unstructuredConverter 接口。<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// source code from: https://github.com/kubernetes/apimachinery/blob/master/pkg/runtime/converter.go
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>// UnstructuredConverter is an interface for converting between interface{}
</span><span style=color:#8f5902;font-style:italic>// and map[string]interface representation.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>UnstructuredConverter</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>ToUnstructured</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>obj</span> <span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{})</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{},</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>FromUnstructured</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>u</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{},</span> <span style=color:#000>obj</span> <span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{})</span> <span style=color:#204a87;font-weight:700>error</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=小结>小结</h2><p>为了便于记忆，现在对前面介绍的各种接口以及实现做一个小结：<p><img src=https://i.loli.net/2021/02/27/6OjGi3QcaCbTrun.jpg alt=k8s-apimachinery.jpg><ol><li>runtime.Object 接口是所有 API 单体资源对象的根类，各个 API 对象的编码与解码依赖于该接口类型；<li>schema.ObjectKind 接口是对 API 资源对象类型的抽象，可以用来获取或者设置 GVK；<li>metav1.Object 接口是 API 资源对象属性的抽象，用来存取资源对象的属性；<li>metav1.ListInterface 接口是 API 对象列表属性的抽象，用来存取资源对象列表的属性；<li>metav1.TypeMeta 结构体实现了 schema.ObjectKind 接口，所有的 API 资源类型继承它；<li>metav1.ObjectMeta 结构体实现了 metav1.Object 接口，所有的 API 资源类型继承它；<li>metav1.ListMeta 结构体实现了 metav1.ListInterface 接口，所有的 API 资源对象列表类型继承它；<li>metav1.Unstructured 结构体实现了 runtime.Unstructured 接口，可以用于构建动态客户端，从 metav1.Unstructured 的实例中可以获取资源类型元信息与资源对象元信息，还可以获取到对象的 map[string]interface{} 的通用内容表示；<li>metav1.Unstructured 与实现了 metav1.Object 接口具体 API 类型进行相互转化，转换依赖于 runtime.UnstructuredConverter 的接口方法。</ol></div><div class="row middle-xs"><div class=col-xs-12><div class=post-category><a href=https://morven.life/categories/note/>note</a></div><div class=post-category><a href=https://morven.life/categories/tech/>tech</a></div></div></div><div class=row><div class=col-xs-12></div></div><div style=height:50px></div><div class=site-footer><div class=site-footer-item><a href=https://morven.life/about/ target=_blank>About Me</a></div></div></div></div></article><script src=https://morven.life/js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById('article')});</script>