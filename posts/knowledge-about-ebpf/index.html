<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.121.1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Morven's Life"><meta property="og:url" content="https://morven.life/posts/knowledge-about-ebpf/"><link rel=canonical href=https://morven.life/posts/knowledge-about-ebpf/><link rel=apple-touch-icon href=https://morven.life/favicon.ico><link rel=icon href=https://morven.life/favicon.ico><link rel=shortcut href=https://morven.life/favicon.ico><link rel=alternate type=application/atom+xml href=https://morven.life/index.xml title="Morven's Life"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/morven.life\/"},"articleSection":"posts","name":"关于 eBPF，我们需要知道的事","headline":"关于 eBPF，我们需要知道的事","description":"什么是 eBPF eBPF 全称为 Extended Berkeley Packet Filter，源于 BPF（Berkeley Packet Filter）, 从其命名可以看出来，它适用于网络报文过滤的功能模块。但是，eBPF已经进化为一个通用的执行引擎，其本质为内核中一个类似于虚拟机的功能模块。eBPF 允许开发者编写在内核中运行的自定义代码，并动态加载到内核，附加到某个处罚 eBPF 程序执行的内核事件上，而不再需要重新编译新的内核模块，可以根据需要动态加载和卸载 eBPF 程序。由此开发者可以基于 eBPF 开发各种网络、可观察性以及安全方面的工具，正因为如此，才让 eBPF 在云原生盛行的当下如鱼得水。\nNote: 最初的 BPF 广泛使用在类 unix 的内核中，而重新设计开发的 eBPF 最早集成在 3.18 的 linux 内核中，此后 BPF 就被被称为经典 BPF，也就是 cBPF（classic BPF），如今的 linux 内核不在运行 cBPF ，内核会将加载的 cBPF 字节码透明地转换成 eBPF 再执行。\neBPF 是如何工作的 一般来说，eBPF 程序包括两部分：\neBPF 程序本身 使用 eBPF 的应用程序 先说使用 eBPF 的应用程序，它运行在用户空间，通过系统调用来加载 eBPF 程序，将其 attach 到某个出发此 eBPF 的内核事件上。如今的内核版本已经支持将 eBPF 程序可以加载到很多类型的内核事件上，最典型的是内核收到网络数据包的事件，这也是 BPF 最初的设计初衷，网络报文的过滤。除此之外，还可以将 eBPF 程序附加到和黑函数的入口（kprobe）以及跟踪点（trace point）等上面。eBPF 的应用程序有时候也需要读取从 eBPF 程序中传回的统计信息，事件报告等。","inLanguage":"en-US","author":"Morven\u0027s Life","creator":"Morven\u0027s Life","publisher":"Morven\u0027s Life","accountablePerson":"Morven\u0027s Life","copyrightHolder":"Morven\u0027s Life","copyrightYear":"2022","datePublished":"2022-10-01 00:00:00 \u002b0000 UTC","dateModified":"2022-10-01 00:00:00 \u002b0000 UTC","url":"https:\/\/morven.life\/posts\/knowledge-about-ebpf\/","keywords":[]}</script><title>关于 eBPF，我们需要知道的事</title>
<meta property="og:title" content="关于 eBPF，我们需要知道的事"><meta property="og:type" content="article"><meta property="og:description" content="什么是 eBPF eBPF 全称为 Extended Berkeley Packet Filter，源于 BPF（Berkeley Packet Filter）, 从其命名可以看出来，它适用于网络报文过滤的功能模块。但是，eBPF已经进化为一个通用的执行引擎，其本质为内核中一个类似于虚拟机的功能模块。eBPF 允许开发者编写在内核中运行的自定义代码，并动态加载到内核，附加到某个处罚 eBPF 程序执行的内核事件上，而不再需要重新编译新的内核模块，可以根据需要动态加载和卸载 eBPF 程序。由此开发者可以基于 eBPF 开发各种网络、可观察性以及安全方面的工具，正因为如此，才让 eBPF 在云原生盛行的当下如鱼得水。
Note: 最初的 BPF 广泛使用在类 unix 的内核中，而重新设计开发的 eBPF 最早集成在 3.18 的 linux 内核中，此后 BPF 就被被称为经典 BPF，也就是 cBPF（classic BPF），如今的 linux 内核不在运行 cBPF ，内核会将加载的 cBPF 字节码透明地转换成 eBPF 再执行。
eBPF 是如何工作的 一般来说，eBPF 程序包括两部分：
eBPF 程序本身 使用 eBPF 的应用程序 先说使用 eBPF 的应用程序，它运行在用户空间，通过系统调用来加载 eBPF 程序，将其 attach 到某个出发此 eBPF 的内核事件上。如今的内核版本已经支持将 eBPF 程序可以加载到很多类型的内核事件上，最典型的是内核收到网络数据包的事件，这也是 BPF 最初的设计初衷，网络报文的过滤。除此之外，还可以将 eBPF 程序附加到和黑函数的入口（kprobe）以及跟踪点（trace point）等上面。eBPF 的应用程序有时候也需要读取从 eBPF 程序中传回的统计信息，事件报告等。"><meta name=description content="什么是 eBPF eBPF 全称为 Extended Berkeley Packet Filter，源于 BPF（Berkeley Packet Filter）, 从其命名可以看出来，它适用于网络报文过滤的功能模块。但是，eBPF已经进化为一个通用的执行引擎，其本质为内核中一个类似于虚拟机的功能模块。eBPF 允许开发者编写在内核中运行的自定义代码，并动态加载到内核，附加到某个处罚 eBPF 程序执行的内核事件上，而不再需要重新编译新的内核模块，可以根据需要动态加载和卸载 eBPF 程序。由此开发者可以基于 eBPF 开发各种网络、可观察性以及安全方面的工具，正因为如此，才让 eBPF 在云原生盛行的当下如鱼得水。
Note: 最初的 BPF 广泛使用在类 unix 的内核中，而重新设计开发的 eBPF 最早集成在 3.18 的 linux 内核中，此后 BPF 就被被称为经典 BPF，也就是 cBPF（classic BPF），如今的 linux 内核不在运行 cBPF ，内核会将加载的 cBPF 字节码透明地转换成 eBPF 再执行。
eBPF 是如何工作的 一般来说，eBPF 程序包括两部分：
eBPF 程序本身 使用 eBPF 的应用程序 先说使用 eBPF 的应用程序，它运行在用户空间，通过系统调用来加载 eBPF 程序，将其 attach 到某个出发此 eBPF 的内核事件上。如今的内核版本已经支持将 eBPF 程序可以加载到很多类型的内核事件上，最典型的是内核收到网络数据包的事件，这也是 BPF 最初的设计初衷，网络报文的过滤。除此之外，还可以将 eBPF 程序附加到和黑函数的入口（kprobe）以及跟踪点（trace point）等上面。eBPF 的应用程序有时候也需要读取从 eBPF 程序中传回的统计信息，事件报告等。"><meta property="og:locale" content="cn"><style>body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:#000;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:#000}.markdown-body blockquote{background-color:#f8f8f8;border-left:2px solid;margin:40px;padding:10px 20px}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:#f6f8fa;border-radius:6px}.markdown-body pre>code{padding:0;font-size:85%;background-color:inherit;border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.signatures{font-family:permanent marker,Impact,Charcoal,sans-serif;font-size:3rem;margin-top:32px}.signatures a{text-decoration:none}.header-line{width:100%;height:3px;background-color:#000;margin:18px 0}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-date,.posts-title{font-size:1.2rem}.posts-line{margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px;margin-bottom:3px}.site-footer{margin-top:50px;margin-bottom:80px;display:flex;justify-content:flex-end;flex-wrap:wrap;padding:12px 0;border-width:3px;border-color:#000}.site-footer-item{margin-right:12px}@media screen and (max-width:600px){.site-header{display:none}.post-content{padding:0 12px}.post-content p{letter-spacing:.05em}}@media screen and (max-width:48em){.posts-category{display:none}}.post-content img{max-width:100%;display:block;margin-left:auto;margin-right:auto;margin-top:12px}.post-header{margin-bottom:50px}.post-title{font-size:2.5rem;font-weight:600}.post-category{display:inline;font-weight:900;margin:0 4px;padding:2px 5px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link href=https://morven.life/index.xml rel=alternate type=application/rss+xml title="Morven's Life"><link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel=stylesheet></head><body><article class="post 简体中文" id=article><div class=row><div class=col-xs-12><header class=post-header><h1 class=post-title>关于 eBPF，我们需要知道的事</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2022-10-01 00:00:00 UTC">01 Oct 2022</time></div><div class=col-xs-6><div class=post-author><a target=_blank href=https://morven.life/>@Morven's Life</a></div></div></div></header><div class="post-content markdown-body"><h2 id=什么是-ebpf>什么是 eBPF</h2><p>eBPF 全称为 Extended Berkeley Packet Filter，源于 BPF（Berkeley Packet Filter）, 从其命名可以看出来，它适用于网络报文过滤的功能模块。但是，eBPF已经进化为一个通用的执行引擎，其本质为内核中一个类似于虚拟机的功能模块。eBPF 允许开发者编写在内核中运行的自定义代码，并动态加载到内核，附加到某个处罚 eBPF 程序执行的内核事件上，而不再需要重新编译新的内核模块，可以根据需要动态加载和卸载 eBPF 程序。由此开发者可以基于 eBPF 开发各种网络、可观察性以及安全方面的工具，正因为如此，才让 eBPF 在云原生盛行的当下如鱼得水。</p><p><img src=https://s2.loli.net/2022/10/09/oG4R2fCb5rcHwZq.jpg alt=what-is-ebpf.jpg></p><p><em>Note:</em> 最初的 BPF 广泛使用在类 unix 的内核中，而重新设计开发的 eBPF 最早集成在 3.18 的 linux 内核中，此后 BPF 就被被称为经典 BPF，也就是 cBPF（classic BPF），如今的 linux 内核不在运行 cBPF ，内核会将加载的 cBPF 字节码透明地转换成 eBPF 再执行。</p><h2 id=ebpf-是如何工作的>eBPF 是如何工作的</h2><p>一般来说，eBPF 程序包括两部分：</p><ul><li>eBPF 程序本身</li><li>使用 eBPF 的应用程序</li></ul><p>先说使用 eBPF 的应用程序，它运行在用户空间，通过系统调用来加载 eBPF 程序，将其 attach 到某个出发此 eBPF 的内核事件上。如今的内核版本已经支持将 eBPF 程序可以加载到很多类型的内核事件上，最典型的是内核收到网络数据包的事件，这也是 BPF 最初的设计初衷，网络报文的过滤。除此之外，还可以将 eBPF 程序附加到和黑函数的入口（kprobe）以及跟踪点（trace point）等上面。eBPF 的应用程序有时候也需要读取从 eBPF 程序中传回的统计信息，事件报告等。</p><p>而 eBPF 程序本身使用 C 语言编写的 “内核代码”，注入到内核之前需要用 <a href=https://llvm.org/>LLVM</a> 编译器编译得到 BPF 字节码，然后加载程序将字节码载入内核。当然，为了防止注入的 eBPF 程序导致内核崩溃，内核中有专门的验证器保证 eBPF 程序的安全性，如 eBPF 不能随意调用内核参数，只能受限于 <a href=https://man7.org/linux/man-pages/man7/bpf-helpers.7.html>BPF helpers</a> 函数；除此之外，eBPF 程序不能包涵不能到达的逻辑，循环必须在有限时间内完成且次数有限制等等。</p><p>eBPF 程序和应用程序可以通过一个位于内核中的 <a href=https://docs.kernel.org/bpf/maps.html>eBPF MAP</a> 来实现双向通信，该 MAP 常驻内存，可以将内核中的统计摘要信息回传给用户空间的应用程序。此外，eBPF MAP 还可用于 eBPF 程序与内核态程序以及 eBPF 程序之间的通信。</p><p><img src=https://s2.loli.net/2022/10/09/C8eNJwuirM6Y7bT.jpg alt=how-ebpf-works.jpg></p><h2 id=ebpf-实例>eBPF 实例</h2><p>按照传统，我们需要编写一个 eBPF 版本的 Hello World，并让其运行起来。我们的 eBPF 程序用 C 语言编写，而 eBPF 应用程序选择使用 Golang + <a href=https://pkg.go.dev/github.com/aquasecurity/tracee/libbpfgo>libbpfgo</a>，当然你也可以选择使用 C 语言。</p><p>本文实例的运行环境信息如下：</p><ul><li>Ubuntu 20.04 LTS</li><li>Kernel Version 5.15.0</li><li>Golang 18.7</li></ul><p>安装依赖：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install make llvm clang libbpf-dev libelf-dev
</span></span></code></pre></div><p><em>Note:</em> 其中 <code>llvm</code> 与 <code>clang</code> 是我们用的到编译器，<code>libbpf-dev</code> 与 <code>libelf-dev</code> 包含我们编写 eBPF 程序的依赖库。</p><p>先看看 eBPF 程序本身。代码信息非常简单，程序的入口通过编译器宏 <code>kprobe/sys_execve</code> 指定，入口函数的参数对于不同的 eBPF 程序类型有着不同的参数，这里参数为 <code>*ctx</code>。核心需要关注的是头文件 <code>&lt;linux/bpf.h></code> 来自kernel的头文件，默认安装在 <code>/usr/include/linux/bpf.h</code>；而 <code>&lt;bpf/bpf_helpers.h></code> 包含 eBPF 的 helpers 函数，来自 <code>libbpf</code>, 这个需要单独安装，我们在依赖准备的时候已经都安装完成了。这段代码的核心函数调用了 <code>bpf_trace_printk</code> 来自于 eBPF 的 helpers 函数。最后代码声明了 SEC 宏来定义 License，因为加载进内核的 eBPF 程序需要有 License 检查。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// +build ignore
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// workround for asm_inline issue: https://github.com/iovisor/bcc/commit/2d1497cde1cc9835f759a707b42dea83bee378b8
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;linux/types.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#ifdef asm_inline
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#undef asm_inline
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#define asm_inline asm
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#endif
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#000>__u64</span> <span style=color:#000>u64</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;linux/bpf.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;bpf/bpf_helpers.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// print tracing message on a kprobe
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>SEC</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;kprobe/sys_execve&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hello</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>msg</span><span style=color:#000;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hello eBPF!</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bpf_trace_printk</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>sizeof</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>LICENSE</span><span style=color:#000;font-weight:700>[]</span> <span style=color:#000>SEC</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;license&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Dual BSD/GPL&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div><p>再来看看加载 eBPF 的应用程序，我们使用 Golang 编写并且使用 libbpfgo 来加载 eBPF 程序到内核，由于这个实力非常简单，并没有涉及到使用 eBPF MAP 来和 eBPF 程序通信。加载程序运行在用户态，最终需要系统调用 <code>bpf()</code> 来加载 eBPF 字节码，此处使用 libbpfgo 帮我们简化这一过程，直接调用 <code>NewModuleFromFile</code> 创建 bpfModule 然后从中得到 <code>hello</code> 的 eBPF 程序并且附加早内核 kprobe。需要注意的是，一个 bpfModule 可以包含多个 eBPF 程序。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>	<span style=color:#4e9a06>&#34;C&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#4e9a06>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#4e9a06>&#34;os/signal&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#4e9a06>&#34;github.com/aquasecurity/tracee/libbpfgo&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>sig</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87>make</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>chan</span> <span style=color:#000>os</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Signal</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000>signal</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Notify</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sig</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>os</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Interrupt</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000>bpfModule</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>libbpfgo</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewModuleFromFile</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello.bpf.o&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>bpfModule</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Close</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>bpfModule</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BPFLoadObject</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000>prog</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>bpfModule</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GetProgram</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>prog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AttachKprobe</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sys_execve</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>go</span> <span style=color:#000>libbpfgo</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TracePrint</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>sig</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>接下来，我们看看如何编译并运行 eBPF 程序。在这个简单的例子中我们先构建对象文件，然后构建用户空间的应用程序，由它来加载 eBPF 字节码到内核，并在用户空间运行应用程序。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#000>ARCH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>shell uname -m<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>TARGET</span> <span style=color:#ce5c00;font-weight:700>:=</span> hello
</span></span><span style=display:flex><span><span style=color:#000>TARGET_BPF</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>$(</span>TARGET<span style=color:#204a87;font-weight:700>)</span>.bpf.o
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>GO_SRC</span> <span style=color:#ce5c00;font-weight:700>:=</span> *.go
</span></span><span style=display:flex><span><span style=color:#000>BPF_SRC</span> <span style=color:#ce5c00;font-weight:700>:=</span> *.bpf.c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>LIBBPF_HEADERS</span> <span style=color:#ce5c00;font-weight:700>:=</span> /usr/include/bpf
</span></span><span style=display:flex><span><span style=color:#000>LIBBPF_OBJ</span> <span style=color:#ce5c00;font-weight:700>:=</span> /usr/lib/<span style=color:#204a87;font-weight:700>$(</span>ARCH<span style=color:#204a87;font-weight:700>)</span>-linux-gnu/libbpf.a
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>.PHONY</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>all</span>
</span></span><span style=display:flex><span><span style=color:#000>all</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>$(</span><span style=color:#000>TARGET</span><span style=color:#204a87;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>$(</span><span style=color:#000>TARGET_BPF</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>go_env</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>CC</span><span style=color:#ce5c00;font-weight:700>=</span>clang <span style=color:#000>CGO_CFLAGS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;-I </span><span style=color:#204a87;font-weight:700>$(</span>LIBBPF_HEADERS<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000>CGO_LDFLAGS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span>LIBBPF_OBJ<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>$(TARGET)</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>$(</span><span style=color:#000>GO_SRC</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>$(</span>go_env<span style=color:#204a87;font-weight:700>)</span> go build -o <span style=color:#204a87;font-weight:700>$(</span>TARGET<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>$(TARGET_BPF)</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>$(</span><span style=color:#000>BPF_SRC</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>	clang <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>		-I /usr/include/<span style=color:#204a87;font-weight:700>$(</span>ARCH<span style=color:#204a87;font-weight:700>)</span>-linux-gnu <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>		-O2 -c -target bpf <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>		-o <span style=color:#000>$@</span> $&lt;
</span></span></code></pre></div><p>有了 makefile， 我们知足要执行 <code>make all</code> 就可以构建我们需要的可执行应用程序和作为目标文件的 eBPF 字节码。然后运行应用程序(以特权身份运行或者拥有 <code>CAP_BPF</code> )，应该看到类似于下面的代码输出：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># make all</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ./hello</span>
</span></span><span style=display:flex><span> amazon-ssm-agen-36390   <span style=color:#ce5c00;font-weight:700>[</span>003<span style=color:#ce5c00;font-weight:700>]</span> d...1 83327.936931: bpf_trace_printk: Hello eBPF!
</span></span><span style=display:flex><span> amazon-ssm-agen-36391   <span style=color:#ce5c00;font-weight:700>[</span>001<span style=color:#ce5c00;font-weight:700>]</span> d...1 83388.944212: bpf_trace_printk: Hello eBPF!
</span></span><span style=display:flex><span>            cron-36394   <span style=color:#ce5c00;font-weight:700>[</span>002<span style=color:#ce5c00;font-weight:700>]</span> d...1 83443.496894: bpf_trace_printk: Hello eBPF!
</span></span><span style=display:flex><span>            bash-36395   <span style=color:#ce5c00;font-weight:700>[</span>003<span style=color:#ce5c00;font-weight:700>]</span> d...1 83443.497557: bpf_trace_printk: Hello eBPF!
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>如果此时，我们在另外一个终端运行 bash，其进程 ID 为 <code>36395</code>，那么上面的输出中可以看到 <code>bash-36395</code> 的进程调用，这也说明了这个简单的 eBPF 版本的 Hello World 可以看到所有这些不同的进程调用的执行，这也就是 eBPF 的强大功能，内核中的 eBPF 程序知道此机器上的所有进程活动信息并传回给用户空间的应用程序。</p><h2 id=ebpf-与-kubernetes>eBPF 与 Kubernetes</h2><p>eBPF 让内核可编程，使得其在云原生领域大放异彩，特别是在 Kubernetes 宇宙中。试想一下，Kubernetes 中的容器或者pod运行于 node 所在的物理机或者虚拟机上面，它们主要运行在用户空间，共享同一个内核；而我们现在可以在 node 的内核中注入开发者的 eBPF 程序，这意味着我们可以在通过 eBPF 知道所有容器或者pod中应用程序的有关信息，包括但不局限于应用程序的发送/接收的网络流量、读写文件，也可以为新创建的 pod 分配 IP等等。实际上，已经有很多基于 eBPF 开发的成熟监控、网络管理已经安全检测的组件，最有名的莫过于 <a href=https://cilium.io/>Cilium</a>.</p><p><img src=https://s2.loli.net/2022/10/09/Y6MkQLrZsDTCpVm.jpg alt=ebpf-kubernetes.jpg></p><p>另外，在 kubernetes 宇宙中，很多组建使用 Sidecar 的模式通过诸如 sidecar 来实现可观察性、流量管理以及安全策略实施等，最典型的莫过于 <a href=https://istio.io/>Istio</a> 使用 istio sidecar 接管 pod 的网络流量来实现构建服务网格。这种模型充分利用 pod 内容器共享相同的网络命名空间以及挂载卷等内容，所以通过注入（手动注入或者通过admission webhook自动注入）sidecar 来获取目标 pod 的活动信息。sidecar 模式的问题在于一旦 sidecar 会带来额外的性能开销，而且一旦sidecar配置正确，可能会导致功能无法正常工作甚至影响应用程序本身的运行，所以，sidecar 模式很难真正地实现副用户完全透明。而 eBPF 的好处在于应用程序的部署不需要做任何更改，就可以知道所有的容器或者 pod 中发生的所有事情，这就是 eBPF 这种内核可编程技术令人兴奋的原因之一，使用 eBPF 来实现可观察性、网络管理以及安全策略实施工具。</p><h2 id=总结>总结</h2><p>eBPF 是一项提高内核中的可观测性、网络和安全性的新技术。它让内核无需更改就可以实现更复杂的功能，由此让开发者可以更加简单且灵活地创建更丰富的工具来支持基础系统设施的运行。我们已经大概知道了 eBPF 是什么、它是如何工作的、以及为什么它在 Kubernetes 宇宙中潜力无穷。当然 eBPF 完美无缺，编写 eBPF 代码不是一件容易的事，而且 eBPF 程序有很多限制，它并不是一个图灵完备的，希望随着内核版本的更迭，eBPF 生态系统也愈加成熟。最后也不得不提到另外一个目前在云原生领域比较流行的虚拟机技术 - <a href=https://webassembly.org/>WebAssembly</a>，它运行在用户空间，却可以处理很多类内核的工作，以至于 CNCF 基于 LLVM 开发了云原生的 WebAssembly 运行时 <a href=https://github.com/WasmEdge>WasmEdge Runtime</a>，这样，原生应用程序将所有沙箱检查合并到原生库中，这允许 WebAssembly 程序表现得像一个独立的 unikernel 库操作系统。</p></div><div class="row middle-xs"><div class=col-xs-12><div class=post-category><a href=https://morven.life/categories/note/>note</a></div><div class=post-category><a href=https://morven.life/categories/tech/>tech</a></div></div></div><div class=row><div class=col-xs-12></div></div><div style=height:50px></div><div class=site-footer><div class=site-footer-item><a href=https://morven.life/about/ target=_blank>About Me</a></div></div></div></div></article><script src=https://morven.life/js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById("article")})</script><script></script></body></html>