<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.104.3"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Morven's Life"><meta property="og:url" content="https://morven.life/posts/networking-2-virtual-devices/"><link rel=canonical href=https://morven.life/posts/networking-2-virtual-devices/><link rel=apple-touch-icon href=https://morven.life/favicon.ico><link rel=icon href=https://morven.life/favicon.ico><link rel=shortcut href=https://morven.life/favicon.ico><link rel=alternate type=application/atom+xml href=https://morven.life/index.xml title="Morven's Life"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/morven.life\/"},"articleSection":"posts","name":"Linux 虚拟网络设备","headline":"Linux 虚拟网络设备","description":"随着容器逐步取代虚拟机，成为现在云基础架构的标准，这些容器的网络管理模块都离不开 Linux 虚拟网络设备。事实上，了解常用的 Linux 虚拟网络设备对于我们理解容器网络以及其他依赖于容器的基础网络架构实现都大有裨益。现在开始，我们就来看看常见的 Linux 虚拟网络设备有哪些以及它们的典型使用场景。\n虚拟网络设备 通过上一篇笔记我们也知道，网络设备的驱动程序并不直接与内核中的协议栈交互，而是通过内核的网络设备管理模块作为中间桥梁。这样做的好处是，驱动程序不需要了解网络协议栈的细节，协议栈也不需要针对特定驱动处理数据包。\n对于内核网络设备管理模块来说，虚拟设备和物理设备没有区别，都是网络设备，都能配置 IP 地址，甚至从逻辑上来看，虚拟网络设备和物理网络设备都类似于管道，从任意一端接收到的数据将从另外一端发送出去。比如物理网卡的两端分别是协议栈与外面的物理网络，从外面物理网络接收到的数据包会转发给协议栈，相反，应用程序通过协议栈发送过来的数据包会通过物理网卡发送到外面的物理网络。但是对于具体将数据包发送到哪里，怎么发送，不同的网络设备有不同的驱动实现，与内核设备管理模块以及协议栈没关系。\n总的来说，虚拟网络设备与物理网络设备没有什么区别，它们的一端连接着内核协议栈，而另一端的行为是什么取决于不同网络设备的驱动实现。\nTUN\/TAP TUN\/TAP 虚拟网络设备一端连着协议栈，另外一端不是物理网络，而是另外一个处于用户空间的应用程序。也就是说，协议栈发给 TUN\/TAP 的数据包能被这个应用程序读取到，当然应用程序能直接向 TUN\/TAP 发送数据包。\n一个典型的使用 TUN\/TAP 网络设备的例子如下图所示：\n上图中我们配置了一个物理网卡，IP 为18.12.0.92，而 tun0 为一个 TUN\/TAP 设备，IP 配置为10.0.0.12。数据包的流向为：\n应用程序 A 通过 socket A 发送了一个数据包，假设这个数据包的目的 IP 地址是 10.0.0.22 socket A 将这个数据包丢给网络协议栈 协议栈根据本地路由规则和数据包的目的 IP，将数据包由给 tun0 设备发送出去 tun0 收到数据包之后，将数据包转发给了用户空间的应用程序 B 应用程序 B 收到数据包之后构造一个新的数据包，将原来的数据包嵌入在新的数据包（IPIP 包）中，最后通过 socket B 将数据包转发出去 Note: 新数据包的源地址变成了 tun0 的地址，而目的 IP 地址则变成了另外一个地址 18.13.0.91.\nsocket B 将数据包发给协议栈 协议栈根据本地路由规则和数据包的目的 IP，决定将这个数据包要通过设备 eth0 发送出去，于是将数据包转发给设备 eth0 设备 eth0 通过物理网络将数据包发送出去 我们看到发送给10.","inLanguage":"en-US","author":"Morven\u0027s Life","creator":"Morven\u0027s Life","publisher":"Morven\u0027s Life","accountablePerson":"Morven\u0027s Life","copyrightHolder":"Morven\u0027s Life","copyrightYear":"2020","datePublished":"2020-01-30 00:00:00 \u002b0000 UTC","dateModified":"2020-01-30 00:00:00 \u002b0000 UTC","url":"https:\/\/morven.life\/posts\/networking-2-virtual-devices\/","keywords":[]}</script><title>Linux 虚拟网络设备</title><meta property="og:title" content="Linux 虚拟网络设备"><meta property="og:type" content="article"><meta property="og:description" content="随着容器逐步取代虚拟机，成为现在云基础架构的标准，这些容器的网络管理模块都离不开 Linux 虚拟网络设备。事实上，了解常用的 Linux 虚拟网络设备对于我们理解容器网络以及其他依赖于容器的基础网络架构实现都大有裨益。现在开始，我们就来看看常见的 Linux 虚拟网络设备有哪些以及它们的典型使用场景。
虚拟网络设备 通过上一篇笔记我们也知道，网络设备的驱动程序并不直接与内核中的协议栈交互，而是通过内核的网络设备管理模块作为中间桥梁。这样做的好处是，驱动程序不需要了解网络协议栈的细节，协议栈也不需要针对特定驱动处理数据包。
对于内核网络设备管理模块来说，虚拟设备和物理设备没有区别，都是网络设备，都能配置 IP 地址，甚至从逻辑上来看，虚拟网络设备和物理网络设备都类似于管道，从任意一端接收到的数据将从另外一端发送出去。比如物理网卡的两端分别是协议栈与外面的物理网络，从外面物理网络接收到的数据包会转发给协议栈，相反，应用程序通过协议栈发送过来的数据包会通过物理网卡发送到外面的物理网络。但是对于具体将数据包发送到哪里，怎么发送，不同的网络设备有不同的驱动实现，与内核设备管理模块以及协议栈没关系。
总的来说，虚拟网络设备与物理网络设备没有什么区别，它们的一端连接着内核协议栈，而另一端的行为是什么取决于不同网络设备的驱动实现。
TUN/TAP TUN/TAP 虚拟网络设备一端连着协议栈，另外一端不是物理网络，而是另外一个处于用户空间的应用程序。也就是说，协议栈发给 TUN/TAP 的数据包能被这个应用程序读取到，当然应用程序能直接向 TUN/TAP 发送数据包。
一个典型的使用 TUN/TAP 网络设备的例子如下图所示：
上图中我们配置了一个物理网卡，IP 为18.12.0.92，而 tun0 为一个 TUN/TAP 设备，IP 配置为10.0.0.12。数据包的流向为：
应用程序 A 通过 socket A 发送了一个数据包，假设这个数据包的目的 IP 地址是 10.0.0.22 socket A 将这个数据包丢给网络协议栈 协议栈根据本地路由规则和数据包的目的 IP，将数据包由给 tun0 设备发送出去 tun0 收到数据包之后，将数据包转发给了用户空间的应用程序 B 应用程序 B 收到数据包之后构造一个新的数据包，将原来的数据包嵌入在新的数据包（IPIP 包）中，最后通过 socket B 将数据包转发出去 Note: 新数据包的源地址变成了 tun0 的地址，而目的 IP 地址则变成了另外一个地址 18.13.0.91.
socket B 将数据包发给协议栈 协议栈根据本地路由规则和数据包的目的 IP，决定将这个数据包要通过设备 eth0 发送出去，于是将数据包转发给设备 eth0 设备 eth0 通过物理网络将数据包发送出去 我们看到发送给10."><meta name=description content="随着容器逐步取代虚拟机，成为现在云基础架构的标准，这些容器的网络管理模块都离不开 Linux 虚拟网络设备。事实上，了解常用的 Linux 虚拟网络设备对于我们理解容器网络以及其他依赖于容器的基础网络架构实现都大有裨益。现在开始，我们就来看看常见的 Linux 虚拟网络设备有哪些以及它们的典型使用场景。
虚拟网络设备 通过上一篇笔记我们也知道，网络设备的驱动程序并不直接与内核中的协议栈交互，而是通过内核的网络设备管理模块作为中间桥梁。这样做的好处是，驱动程序不需要了解网络协议栈的细节，协议栈也不需要针对特定驱动处理数据包。
对于内核网络设备管理模块来说，虚拟设备和物理设备没有区别，都是网络设备，都能配置 IP 地址，甚至从逻辑上来看，虚拟网络设备和物理网络设备都类似于管道，从任意一端接收到的数据将从另外一端发送出去。比如物理网卡的两端分别是协议栈与外面的物理网络，从外面物理网络接收到的数据包会转发给协议栈，相反，应用程序通过协议栈发送过来的数据包会通过物理网卡发送到外面的物理网络。但是对于具体将数据包发送到哪里，怎么发送，不同的网络设备有不同的驱动实现，与内核设备管理模块以及协议栈没关系。
总的来说，虚拟网络设备与物理网络设备没有什么区别，它们的一端连接着内核协议栈，而另一端的行为是什么取决于不同网络设备的驱动实现。
TUN/TAP TUN/TAP 虚拟网络设备一端连着协议栈，另外一端不是物理网络，而是另外一个处于用户空间的应用程序。也就是说，协议栈发给 TUN/TAP 的数据包能被这个应用程序读取到，当然应用程序能直接向 TUN/TAP 发送数据包。
一个典型的使用 TUN/TAP 网络设备的例子如下图所示：
上图中我们配置了一个物理网卡，IP 为18.12.0.92，而 tun0 为一个 TUN/TAP 设备，IP 配置为10.0.0.12。数据包的流向为：
应用程序 A 通过 socket A 发送了一个数据包，假设这个数据包的目的 IP 地址是 10.0.0.22 socket A 将这个数据包丢给网络协议栈 协议栈根据本地路由规则和数据包的目的 IP，将数据包由给 tun0 设备发送出去 tun0 收到数据包之后，将数据包转发给了用户空间的应用程序 B 应用程序 B 收到数据包之后构造一个新的数据包，将原来的数据包嵌入在新的数据包（IPIP 包）中，最后通过 socket B 将数据包转发出去 Note: 新数据包的源地址变成了 tun0 的地址，而目的 IP 地址则变成了另外一个地址 18.13.0.91.
socket B 将数据包发给协议栈 协议栈根据本地路由规则和数据包的目的 IP，决定将这个数据包要通过设备 eth0 发送出去，于是将数据包转发给设备 eth0 设备 eth0 通过物理网络将数据包发送出去 我们看到发送给10."><meta property="og:locale" content="en-us"><style>body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:#000;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:#000}.markdown-body blockquote{background-color:#f8f8f8;border-left:2px solid;margin:40px;padding:10px 20px}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:#f6f8fa;border-radius:6px}.markdown-body pre>code{padding:0;font-size:85%;background-color:inherit;border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.signatures{font-family:permanent marker,Impact,Charcoal,sans-serif;font-size:3rem;margin-top:32px}.signatures a{text-decoration:none}.header-line{width:100%;height:3px;background-color:#000;margin:18px 0}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-date,.posts-title{font-size:1.2rem}.posts-line{margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px;margin-bottom:3px}.site-footer{margin-top:50px;margin-bottom:80px;display:flex;justify-content:flex-end;flex-wrap:wrap;padding:12px 0;border-width:3px;border-color:#000}.site-footer-item{margin-right:12px}@media screen and (max-width:600px){.site-header{display:none}.post-content{padding:0 12px}.post-content p{letter-spacing:.05em}}@media screen and (max-width:48em){.posts-category{display:none}}.post-content img{max-width:100%;display:block;margin-left:auto;margin-right:auto;margin-top:12px}.post-header{margin-bottom:50px}.post-title{font-size:2.5rem;font-weight:600}.post-category{display:inline;font-weight:900;margin:0 4px;padding:2px 5px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link href=https://morven.life/index.xml rel=alternate type=application/rss+xml title="Morven's Life"><link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel=stylesheet></head><body><article class="post 简体中文" id=article><div class=row><div class=col-xs-12><header class=post-header><h1 class=post-title>Linux 虚拟网络设备</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2020-01-30 00:00:00 UTC">30 Jan 2020</time></div><div class=col-xs-6><div class=post-author><a target=_blank href=https://morven.life/>@Morven's Life</a></div></div></div></header><div class="post-content markdown-body"><p>随着容器逐步取代虚拟机，成为现在云基础架构的标准，这些容器的网络管理模块都离不开 Linux 虚拟网络设备。事实上，了解常用的 Linux 虚拟网络设备对于我们理解容器网络以及其他依赖于容器的基础网络架构实现都大有裨益。现在开始，我们就来看看常见的 Linux 虚拟网络设备有哪些以及它们的典型使用场景。</p><h2 id=虚拟网络设备>虚拟网络设备</h2><p>通过上一篇笔记我们也知道，网络设备的驱动程序并不直接与内核中的协议栈交互，而是通过内核的网络设备管理模块作为中间桥梁。这样做的好处是，驱动程序不需要了解网络协议栈的细节，协议栈也不需要针对特定驱动处理数据包。</p><p>对于内核网络设备管理模块来说，虚拟设备和物理设备没有区别，都是网络设备，都能配置 IP 地址，甚至从逻辑上来看，虚拟网络设备和物理网络设备都类似于管道，从任意一端接收到的数据将从另外一端发送出去。比如物理网卡的两端分别是协议栈与外面的物理网络，从外面物理网络接收到的数据包会转发给协议栈，相反，应用程序通过协议栈发送过来的数据包会通过物理网卡发送到外面的物理网络。但是对于具体将数据包发送到哪里，怎么发送，不同的网络设备有不同的驱动实现，与内核设备管理模块以及协议栈没关系。</p><p>总的来说，虚拟网络设备与物理网络设备没有什么区别，它们的一端连接着内核协议栈，而另一端的行为是什么取决于不同网络设备的驱动实现。</p><h3 id=tuntap>TUN/TAP</h3><p>TUN/TAP 虚拟网络设备一端连着协议栈，另外一端不是物理网络，而是另外一个处于用户空间的应用程序。也就是说，协议栈发给 TUN/TAP 的数据包能被这个应用程序读取到，当然应用程序能直接向 TUN/TAP 发送数据包。</p><p>一个典型的使用 TUN/TAP 网络设备的例子如下图所示：</p><p><img src=https://i.loli.net/2021/02/01/5NYEzLXpmPSg8on.jpg alt=network-device-tun-tap.jpg></p><p>上图中我们配置了一个物理网卡，IP 为<code>18.12.0.92</code>，而 tun0 为一个 TUN/TAP 设备，IP 配置为<code>10.0.0.12</code>。数据包的流向为：</p><ol><li>应用程序 A 通过 socket A 发送了一个数据包，假设这个数据包的目的 IP 地址是 <code>10.0.0.22</code></li><li>socket A 将这个数据包丢给网络协议栈</li><li>协议栈根据本地路由规则和数据包的目的 IP，将数据包由给 tun0 设备发送出去</li><li>tun0 收到数据包之后，将数据包转发给了用户空间的应用程序 B</li><li>应用程序 B 收到数据包之后构造一个新的数据包，将原来的数据包嵌入在新的数据包（IPIP 包）中，最后通过 socket B 将数据包转发出去</li></ol><blockquote><p>Note: 新数据包的源地址变成了 tun0 的地址，而目的 IP 地址则变成了另外一个地址 <code>18.13.0.91</code>.</p></blockquote><ol start=6><li>socket B 将数据包发给协议栈</li><li>协议栈根据本地路由规则和数据包的目的 IP，决定将这个数据包要通过设备 eth0 发送出去，于是将数据包转发给设备 eth0</li><li>设备 eth0 通过物理网络将数据包发送出去</li></ol><p>我们看到发送给<code>10.0.0.22</code>的网络数据包通过在用户空间的应用程序 B，利用<code>18.12.0.92</code>发到远端网络的<code>18.13.0.91</code>，网络包到达<code>18.13.0.91</code>后，读取里面的原始数据包，再转发给本地的<code>10.0.0.22</code>。这就是 <a href=https://en.wikipedia.org/wiki/Virtual_private_network>VPN</a> 的基本实现原理。</p><p>使用 TUN/TAP 设备我们有机会将协议栈中的部分数据包转发给用户空间的应用程序，让应用程序处理数据包。常用的使用场景包括数据压缩、加密等功能。</p><blockquote><p>Note: TUN 和 TAP 设备的区别在于，TUN 设备是一个虚拟的端到端 IP 层设备，也就是说用户空间的应用程序通过 TUN 设备只能读写 IP 网络数据包（三层），而 TAP 设备是一个虚拟的链路层设备，通过 TAP 设备能读写链路层数据包（二层）。如果使用 Linux 网络工具包 <a href=https://en.wikipedia.org/wiki/Iproute2>iproute2</a> 来创建网络设备 TUN/TAP 设备
则需要指定 <code>--dev tun</code> 和 <code>--dev tap</code> 来区分。</p></blockquote><h3 id=veth>veth</h3><p>veth 虚拟网络设备一端连着协议栈，另外一端不是物理网络，而是另一个 veth 设备，成对的 veth 设备中一个数据包发送出去后会直接到另一个 veth 设备上去。每个 veth 设备都可以配置 IP 地址，并参与三层 IP 网络的路由过程。</p><p>下面就是一个典型的使用 veth 设备对的例子：</p><p><img src=https://i.loli.net/2020/01/28/dOA19SeZHPLanYC.jpg alt=network-device-veth.jpg></p><p>我们配置物理网卡 eth0 的 IP 地址为<code>12.124.10.11</code>，这里 veth 设备对分别为 veth0 和 veth1，它们的 IP 分别是<code>20.1.0.10</code>和<code>20.1.0.11</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip link add veth0 type veth peer name veth1</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip addr add 20.1.0.10/24 dev veth0</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip addr add 20.1.0.11/24 dev veth1</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip link set veth0 up</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip link set veth1 up</span>
</span></span></code></pre></div><p>然后尝试从 veth0 设备 ping 另一个设备 veth1：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ping -c 2 20.1.0.11 -I veth0</span>
</span></span><span style=display:flex><span>PING 20.1.0.11 <span style=color:#ce5c00;font-weight:700>(</span>20.1.0.11<span style=color:#ce5c00;font-weight:700>)</span> from 20.1.0.11 veth0: 28<span style=color:#ce5c00;font-weight:700>(</span>42<span style=color:#ce5c00;font-weight:700>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>64</span> bytes from 20.1.0.11: <span style=color:#000>icmp_seq</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>ttl</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64</span> <span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>=</span>0.034 ms
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>64</span> bytes from 20.1.0.11: <span style=color:#000>icmp_seq</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000>ttl</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64</span> <span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>=</span>0.052 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 20.1.0.11 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>2</span> packets transmitted, <span style=color:#0000cf;font-weight:700>2</span> received, 0% packet loss, <span style=color:#204a87>time</span> 1500ms
</span></span></code></pre></div><blockquote><p>Note: 在有些版本的 Ubuntu 中有可能会 ping 不通，原因是默认情况下内核网络配置导致 veth 设备对无法返回 ARP 包，解决办法是配置 veth 设备可以返回 ARP 包：</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># echo 1 &gt; /proc/sys/net/ipv4/conf/veth1/accept_local</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># echo 1 &gt; /proc/sys/net/ipv4/conf/veth0/accept_local</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># echo 0 &gt; /proc/sys/net/ipv4/conf/veth0/rp_filter</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># echo 0 &gt; /proc/sys/net/ipv4/conf/veth1/rp_filter</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># echo 0 &gt; /proc/sys/net/ipv4/conf/all/rp_filter</span>
</span></span></code></pre></div><p>可以尝试使用 tcpdump 命令看看在 veth 设备对上的请求包：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># tcpdump -n -i veth1</span>
</span></span><span style=display:flex><span>tcpdump: verbose output suppressed, use -v or -vv <span style=color:#204a87;font-weight:700>for</span> full protocol decode
</span></span><span style=display:flex><span>listening on veth1, link-type EN10MB <span style=color:#ce5c00;font-weight:700>(</span>Ethernet<span style=color:#ce5c00;font-weight:700>)</span>, capture size <span style=color:#0000cf;font-weight:700>458122</span> bytes
</span></span><span style=display:flex><span>20:24:12.220002 ARP, Request who-has 20.1.0.11 tell 20.1.0.10, length <span style=color:#0000cf;font-weight:700>28</span>
</span></span><span style=display:flex><span>20:24:12.220198 ARP, Request who-has 20.1.0.11 tell 20.1.0.10, length <span style=color:#0000cf;font-weight:700>28</span>
</span></span><span style=display:flex><span>20:24:12.221372 IP 20.1.0.10 &gt; 20.1.0.11: ICMP <span style=color:#204a87>echo</span> request, id 18174, seq 1, length <span style=color:#0000cf;font-weight:700>64</span>
</span></span><span style=display:flex><span>20:24:13.222089 IP 20.1.0.10 &gt; 20.1.0.11: ICMP <span style=color:#204a87>echo</span> request, id 18174, seq 2, length <span style=color:#0000cf;font-weight:700>64</span>
</span></span></code></pre></div><p>可以看到在 veth1 上面只有 ICMP echo 的请求包，但是没有应答包。仔细想一下，veth1 收到 ICMP echo请求包后，转交给另一端的协议栈，但是协议栈检查当前的设备列表，发现本地有<code>20.1.0.10</code>，于是构造 ICMP echo 应答包，并转发给 lo 设备，lo 设备收到数据包之后直接交给协议栈，紧接着给交给用户空间的 ping 进程。</p><p>我们可以尝试使用 tcpdump 抓取 lo 设备上的数据：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># tcpdump -n -i lo</span>
</span></span><span style=display:flex><span>tcpdump: verbose output suppressed, use -v or -vv <span style=color:#204a87;font-weight:700>for</span> full protocol decode
</span></span><span style=display:flex><span>listening on lo, link-type EN10MB <span style=color:#ce5c00;font-weight:700>(</span>Ethernet<span style=color:#ce5c00;font-weight:700>)</span>, capture size <span style=color:#0000cf;font-weight:700>458122</span> bytes
</span></span><span style=display:flex><span>20:25:49.486019 IP IP 20.1.0.11 &gt; 20.1.0.10: ICMP <span style=color:#204a87>echo</span> reply, id 24177, seq 1, length <span style=color:#0000cf;font-weight:700>64</span>
</span></span><span style=display:flex><span>20:25:50.4861228 IP IP 20.1.0.11 &gt; 20.1.0.10: ICMP <span style=color:#204a87>echo</span> reply, id 24177, seq 2, length <span style=color:#0000cf;font-weight:700>64</span>
</span></span></code></pre></div><p>由此可见，对于成对出现的 veth 设备对，从一个设备出去的数据包会直接发给另外一个设备。在实际的应用场景中，比如容器网络中，成对的 veth 设备对处于不同的<a href=https://blog.scottlowe.org/2013/09/04/introducing-linux-network-namespaces/>网络命名空间</a>中，数据包的转发在不同网络命名空间之间进行，后续在介绍容器网络的时候会详细说明。</p><h3 id=bridge>bridge</h3><p><a href=https://wiki.linuxfoundation.org/networking/bridge>bridge</a> 一般叫作“网桥”，也是一种虚拟网络设备，所以具有虚拟网络设备的特征，可以配置 IP、MAC 地址等。与其他网络设备不同的是，bridge 是一个虚拟交换机，和物理交换机有类似的功能。bridge 一端连接着协议栈，另外一端有多个端口，数据在各个端口间转发数据包是基于 MAC 地址。</p><p>bridge 可以工作在二层(链路层)，也可以工作在三层（IP 网路层）。默认情况下，其工作在二层，可以在同一子网内的的不同主机间转发以太网报文；当给 bridge 分配了 IP 地址，也就开启了该 bridge 的三层工作模式。在 Linux 下，你可以用 <a href=https://wiki.linuxfoundation.org/networking/iproute2>iproute2</a> 或 <code>brctl</code> 命令对 bridge 进行管理。</p><p>创建 bridge 与创建其他虚拟网络设备类似，只需要指定 type 参数为 <code>bridge</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip link add name br0 type bridge</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip link set br0 up</span>
</span></span></code></pre></div><p><img src=https://i.loli.net/2020/01/28/JljuUAEyNRfb6Dq.jpg alt=network-device-bridge-1.jpg></p><p>但是这样创建出来的 bridge 一端连接着协议栈，其他端口什么也没有连接，因此我们需要将其他设备连接到该 bridge 才能有实际的功能：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip link add veth0 type veth peer name veth1</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip addr add 20.1.0.10/24 dev veth0</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip addr add 20.1.0.11/24 dev veth1</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip link set veth0 up</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip link set veth1 up</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 将 veth0 连接到 br0</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip link set dev veth0 master br0</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过 bridge link 命令可以看到 bridge 上连接了哪些设备</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># bridge link</span>
</span></span><span style=display:flex><span>6: veth0 state UP : &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#0000cf;font-weight:700>1500</span> master br0 state forwarding priority <span style=color:#0000cf;font-weight:700>32</span> cost <span style=color:#0000cf;font-weight:700>2</span>
</span></span></code></pre></div><p><img src=https://i.loli.net/2020/01/28/NCUXi4l7zBo83ev.jpg alt=network-device-bridge-2.jpg></p><p>事实上，一旦 br0 和 veth0 连接之后，它们之间将变成双向通道，但是内核协议栈和 veth0 之间变成了单通道，协议栈能发数据给 veth0，但 veth0 从外面收到的数据不会转发给协议栈，同时 br0 的 MAC 地址变成了 veth0 的 MAC 地址。我们可以验证一下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ping -c 1 -I veth0 20.1.0.11</span>
</span></span><span style=display:flex><span>PING 20.1.0.11 <span style=color:#ce5c00;font-weight:700>(</span>20.1.0.11<span style=color:#ce5c00;font-weight:700>)</span> from 20.1.0.10 veth0: 56<span style=color:#ce5c00;font-weight:700>(</span>84<span style=color:#ce5c00;font-weight:700>)</span> bytes of data.
</span></span><span style=display:flex><span>From 20.1.0.10 <span style=color:#000>icmp_seq</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span> Destination Host Unreachable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 20.1.0.11 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1</span> packets transmitted, <span style=color:#0000cf;font-weight:700>0</span> received, +1 errors, 100% packet loss, <span style=color:#204a87>time</span> 0ms
</span></span></code></pre></div><p>如果我们使用 tcpdump 在 br0 上抓包就会发现：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># tcpdump -n -i br0</span>
</span></span><span style=display:flex><span>tcpdump: verbose output suppressed, use -v or -vv <span style=color:#204a87;font-weight:700>for</span> full protocol decode
</span></span><span style=display:flex><span>listening on br0, link-type EN10MB <span style=color:#ce5c00;font-weight:700>(</span>Ethernet<span style=color:#ce5c00;font-weight:700>)</span>, capture size <span style=color:#0000cf;font-weight:700>262144</span> bytes
</span></span><span style=display:flex><span>21:45:48.225459 ARP, Reply 20.1.0.10 is-at a2:85:26:b3:72:6c, length <span style=color:#0000cf;font-weight:700>28</span>
</span></span></code></pre></div><p>可以看到 veth0 收到应答包后没有给协议栈，而是直接转发给 br0，这样协议栈得不到 veth1 的 MAC 地址，从而 ping 不通。br0 在 veth0 和协议栈之间将数据包给拦截了。但是如果我们给 br0 配置 IP，会怎么样呢？</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip addr del 20.1.0.10/24 dev veth0</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ip addr add 20.1.0.10/24 dev br0</span>
</span></span></code></pre></div><p>这样，网络结构就变成了下面这样：</p><p><img src=https://i.loli.net/2020/01/28/nuKtLZyaRhXqjDp.jpg alt=network-device-bridge-3.jpg></p><p>这时候再通过 br0 来 ping 一下 veth1，会发现结果可以通：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ping -c 1 -I br0 20.1.0.11</span>
</span></span><span style=display:flex><span>PING 20.1.0.11 <span style=color:#ce5c00;font-weight:700>(</span>20.1.0.11<span style=color:#ce5c00;font-weight:700>)</span> from 20.1.0.10 br0: 56<span style=color:#ce5c00;font-weight:700>(</span>84<span style=color:#ce5c00;font-weight:700>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>64</span> bytes from 20.1.0.11: <span style=color:#000>icmp_seq</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>ttl</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64</span> <span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>=</span>0.121 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 20.1.0.11 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>1</span> packets transmitted, <span style=color:#0000cf;font-weight:700>1</span> received, 0% packet loss, <span style=color:#204a87>time</span> 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#ce5c00;font-weight:700>=</span> 0.121/0.121/0.121/0.000 ms
</span></span></code></pre></div><p>其实当去掉 veth0 的 IP，而给 br0 配置了 IP 之后，协议栈在路由的时候不会将数据包发给 veth0，为了表达更直观，我们协议栈和 veth0 之间的连接线去掉，这时候的 veth0 相当于一根网线。</p><p>在现实中，bridge 常用的使用场景：</p><p><strong>虚拟机</strong></p><p>典型的虚拟机网络实现就是通过 TUN/TAP 将虚拟机内的网卡同宿主机的 br0 连接起来，这时 br0 和物理交换机的效果类似，虚拟机发出去的数据包先到达 br0，然后由 br0 交给 eth0 发送出去，这样做数据包都不需要经过宿主机的协议栈，运行效率非常高。</p><p><img src=https://i.loli.net/2020/01/28/u4GDayrE3c6kPxs.jpg alt=network-device-vm.jpg></p><p><strong>容器</strong></p><p>而对于容器网络来说，每个容器的网络设备单独的网络命名空间中，所以很好地不同容器的协议栈，我们在接下来的笔记中进一步讨论不同的容器网络实现。</p><p><img src=https://i.loli.net/2020/01/28/IPSwuRVbgTDKnhB.jpg alt=network-device-docker.jpg></p><h2 id=参考>参考</h2><ul><li><a href=https://backreference.org/2010/03/26/tuntap-interface-tutorial/>https://backreference.org/2010/03/26/tuntap-interface-tutorial/</a></li><li><a href=https://blog.scottlowe.org/2013/09/04/introducing-linux-network-namespaces/>https://blog.scottlowe.org/2013/09/04/introducing-linux-network-namespaces/</a></li><li><a href=https://www.ibm.com/developerworks/cn/linux/1310_xiawc_networkdevice/>https://www.ibm.com/developerworks/cn/linux/1310_xiawc_networkdevice/</a></li><li><a href=http://ifeanyi.co/posts/linux-namespaces-part-1/>http://ifeanyi.co/posts/linux-namespaces-part-1/</a></li><li><a href="http://www.opencloudblog.com/?p=66">http://www.opencloudblog.com/?p=66</a></li></ul></div><div class="row middle-xs"><div class=col-xs-12><div class=post-category><a href=https://morven.life/categories/note/>note</a></div><div class=post-category><a href=https://morven.life/categories/tech/>tech</a></div></div></div><div class=row><div class=col-xs-12></div></div><div style=height:50px></div><div class=site-footer><div class=site-footer-item><a href=https://morven.life/about/ target=_blank>About Me</a></div></div></div></div></article><script src=https://morven.life/js/lazyload.min.js></script>
<script>var lazyImage=new LazyLoad({container:document.getElementById("article")})</script><script></script></body></html>